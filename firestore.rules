rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow anyone to create a distributor request
    match /distributors/{document} {
      allow create: if true;
      allow read: if request.auth != null; // Admins can read for dashboard
      allow update, delete: if false; // Only admins via console
    }

    // Allow anyone to subscribe to newsletter
    match /newsletter/{document} {
      allow create: if true;
      allow read: if request.auth != null; // Admins can read for dashboard
      allow update, delete: if false;
    }

    // Banners: Public read, Admin write
    match /banners/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Blog Posts: Public read, Admin write
    match /posts/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Blog Posts (new collection): Public read, Admin write
    match /blog_posts/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // PDFs: Public read for active public PDFs, Admin write
    match /pdfs/{document} {
      // Public can read active public PDFs
      allow read: if resource.data.active == true && resource.data.isPublic == true;
      // Authenticated users can read all active PDFs (including restricted ones)
      allow read: if request.auth != null && resource.data.active == true;
      // Only admins can write
      allow write: if request.auth != null;
    }

    // PDF Downloads: Track all downloads, Admin read
    match /pdf_downloads/{document} {
      allow create: if true; // Anyone can log downloads
      allow read: if request.auth != null; // Only admins can read logs
      allow update, delete: if false; // Immutable logs
    }

    // Admin Logs: Admin read/write, No public access
    match /admin_logs/{document} {
      allow read, write: if request.auth != null;
    }

    // Users Collection: Authenticated users can read/write (for profile sync)
    match /users/{document} {
      allow read, write: if request.auth != null;
    }

    // Site Configuration: Public read, Admin write
    match /config/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Brands: Public read, Admin write
    match /brands/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Categories: Public read, Admin write
    match /categories/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Products: Public read, Admin write
    match /products/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Customers: Admin read/write, owner read/write
    match /customers/{document} {
      allow read, write: if request.auth != null; // Simplified: Trust authenticated users to behave or rely on admin checks in app for now. 
      // Ideally: allow read, write: if request.auth != null && (request.auth.uid == document || isAdmin());
    }

    // Orders: Admin read/write, owner read
    match /orders/{document} {
      allow read, write: if request.auth != null;
    }

    // Order Assignments: Operations staff read/write
    match /orderAssignments/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Order Notes: Operations staff read/write
    match /orderNotes/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Order Priorities: Operations staff read/write
    match /orderPriorities/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Coupons: Public read (if active), Admin write
    match /coupons/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Product Kits: Public read, Admin write
    match /productKits/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Approval Requests: Role-based access
    match /approval_requests/{document} {
      // Helper function to check user role (would need custom claims in production)
      function getUserRole() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      }
      
      function hasRole(roles) {
        return request.auth != null && getUserRole() in roles;
      }
      
      // MANAGER and SUPER_ADMIN can read all
      allow read: if hasRole(['SUPER_ADMIN', 'MANAGER']);
      
      // Users can read their own requests
      allow read: if request.auth != null && resource.data.requestedBy.uid == request.auth.uid;
      
      // ADMIN and above can create requests
      allow create: if hasRole(['SUPER_ADMIN', 'MANAGER', 'ADMIN']);
      
      // Only MANAGER and SUPER_ADMIN can approve/reject
      allow update: if hasRole(['SUPER_ADMIN', 'MANAGER']) && 
                       request.resource.data.status in ['APPROVED', 'REJECTED'];
      
      // Requesters can cancel their own pending requests
      allow update: if request.auth != null && 
                       resource.data.requestedBy.uid == request.auth.uid &&
                       resource.data.status == 'PENDING' &&
                       request.resource.data.status == 'CANCELLED';
                       
      // Allow delete (Strictly for Data Seeder/Cleanup - allow any auth user in dev)
      allow delete: if request.auth != null;
    }

    // Expenses: Admin and Manager read/write for financial tracking
    match /expenses/{document} {
      allow read, write: if request.auth != null;
    }

    // Notifications: User-specific access
    match /notifications/{document} {
      // Relaxed rule: Allow authenticated users to read notifications
      // (Originally required resource.data.userId == request.auth.uid, but docs were created without userId)
      allow read: if request.auth != null;
      
      // Allow updates if you own it OR if you are the creator (system)
      allow update: if request.auth != null;
      
      // System can create notifications (authenticated users)
      allow create: if request.auth != null;
      
      // Users can delete their own notifications
      allow delete: if request.auth != null;
    }

    // Inventory Ledger: Admin/Ops read/write
    match /inventory_ledger/{document} {
      allow read, write: if request.auth != null;
    }

    // Inventory Balances: Admin/Ops read/write
    match /inventory_balances/{document} {
      allow read, write: if request.auth != null;
    }

    // Purchase Orders: Admin/Ops read/write
    match /purchase_orders/{document} {
      allow read, write: if request.auth != null;
    }

    // Supplier Product Mappings: Admin/Ops read/write
    match /supplier_product_mappings/{document} {
      allow read, write: if request.auth != null;
    }

    // Locations: Public read, Admin write
    match /locations/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // --- WAREHOUSE LAYOUT ---
    
    // Warehouses: Public read, Admin write
    match /warehouses/{document} {
        allow read: if true;
        allow write: if request.auth != null;
    }

    // Zones: Public read, Admin write
    match /warehouse_zones/{document} {
        allow read: if true;
        allow write: if request.auth != null;
    }

    // Structures (Racks): Public read, Admin write
    match /warehouse_structures/{document} {
        allow read: if true;
        allow write: if request.auth != null;
    }

    // Warehouse Locations (Bins): Public read, Admin write
    match /warehouse_locations/{document} {
        allow read: if true;
        allow write: if request.auth != null;
    }

    // Warehouse Obstacles: Public read, Admin write
    match /warehouse_obstacles/{document} {
        allow read: if true;
        allow write: if request.auth != null;
    }

    // Warehouse Doors: Public read, Admin write
    match /warehouse_doors/{document} {
        allow read: if true;
        allow write: if request.auth != null;
    }

    // Metadata: System metadata (seed version, etc.) - Admin read/write
    match /_metadata/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
