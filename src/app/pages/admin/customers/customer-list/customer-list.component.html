<div class="product-dashboard-layout">
    <!-- Sticky Command Header -->
    <header class="command-header">
        <div class="header-left">
            <div class="header-title-section">
                <h1 class="page-title">{{ 'ADMIN.CUSTOMERS.TITLE' | translate }}</h1>
                <span class="product-badge" *ngIf="filteredCustomers.length > 0">{{ filteredCustomers.length }}</span>
            </div>
        </div>

        <div class="header-right" style="display: flex; gap: 12px; align-items: center;">
            <button class="btn-ghost" (click)="exportToCSV()" [disabled]="filteredCustomers.length === 0"
                title="{{ 'ADMIN.COMMON.EXPORT' | translate }}"
                style="color: #e4e4e7; background: #27272a; border: 1px solid #3f3f46; padding: 8px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span class="icon">üì•</span>
                <span class="text" style="font-size: 0.9rem;">{{ 'ADMIN.COMMON.EXPORT' | translate }}</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="product-grid-view">

        <!-- Unified Search & Filter Toolbar -->
        <div class="table-toolbar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" [formControl]="searchControl"
                    [placeholder]="'ADMIN.CUSTOMERS.SEARCH_PLACEHOLDER' | translate">
            </div>

            <!-- Customer Type Filter -->
            <select class="filter-select" [value]="filterType" (change)="setFilterType($any($event.target).value)">
                <option value="all">All Customers</option>
                <option value="active">Active Buyers</option>
                <option value="new">New Signups</option>
            </select>

            <button class="btn-clear-filters" *ngIf="filterType !== 'all' || searchControl.value"
                (click)="setFilterType('all'); searchControl.reset()">
                {{ 'ADMIN.COMMON.CLEAR_FILTERS' | translate }}
            </button>
        </div>

        <!-- Glass Table -->
        <div class="table-glass-container" *ngIf="!isLoading && filteredCustomers.length > 0; else noDataOrLoading">
            <table class="rich-table">
                <thead>
                    <tr>
                        <th class="sortable" (click)="sort('displayName')">
                            {{ 'ADMIN.CUSTOMERS.TABLE.CUSTOMER' | translate }}
                            <span *ngIf="sortColumn === 'displayName'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                            <span *ngIf="sortColumn !== 'displayName'" class="sort-hint">‚Üï</span>
                        </th>
                        <th class="sortable" (click)="sort('email')">
                            {{ 'ADMIN.CUSTOMERS.TABLE.EMAIL' | translate }}
                            <span *ngIf="sortColumn === 'email'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                            <span *ngIf="sortColumn !== 'email'" class="sort-hint">‚Üï</span>
                        </th>
                        <th class="sortable" (click)="sort('createdAt')">
                            {{ 'ADMIN.CUSTOMERS.TABLE.JOINED' | translate }}
                            <span *ngIf="sortColumn === 'createdAt'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                            <span *ngIf="sortColumn !== 'createdAt'" class="sort-hint">‚Üï</span>
                        </th>
                        <th class="text-right sortable" (click)="sort('orders')">
                            {{ 'ADMIN.CUSTOMERS.TABLE.ORDERS' | translate }}
                            <span *ngIf="sortColumn === 'orders'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                            <span *ngIf="sortColumn !== 'orders'" class="sort-hint">‚Üï</span>
                        </th>
                        <th class="text-right sortable" (click)="sort('spend')">
                            {{ 'ADMIN.CUSTOMERS.TABLE.SPEND' | translate }}
                            <span *ngIf="sortColumn === 'spend'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                            <span *ngIf="sortColumn !== 'spend'" class="sort-hint">‚Üï</span>
                        </th>
                        <th>Status</th>
                        <th class="text-right">{{ 'ADMIN.CUSTOMERS.TABLE.ACTIONS' | translate }}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let customer of paginatedCustomers; trackBy: trackByUid">
                        <td>
                            <div class="product-identity">
                                <div class="img-thumbnail">
                                    <img *ngIf="customer.photoURL" [src]="customer.photoURL">
                                    <div *ngIf="!customer.photoURL" class="img-placeholder"
                                        [style.background-color]="getItemsBgColor(customer.email)"
                                        style="color: white; font-size: 1rem;">
                                        {{ customer.displayName?.charAt(0) || customer.email.charAt(0) | uppercase }}
                                    </div>
                                </div>
                                <div>
                                    <a [routerLink]="['/admin/customers', customer.uid]" class="product-name">
                                        {{ customer.displayName || 'Guest' }}
                                    </a>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="product-sku">{{ customer.email }}</span>
                        </td>
                        <td>
                            <div class="product-info">
                                <strong>{{ customer.createdAt | date:'mediumDate' }}</strong>
                            </div>
                        </td>
                        <td class="text-right">
                            <span class="badge-count">{{ customer.stats?.totalOrders || 0 }}</span>
                        </td>
                        <td class="text-right">
                            <span class="price-text">{{ (customer.stats?.totalSpend || 0) | currency }}</span>
                        </td>
                        <td>
                            <div class="stock-pill" [class.success]="customer.isActive"
                                [class.danger]="!customer.isActive">
                                <span class="dot"></span>
                                {{ customer.isActive ? 'Active' : 'Inactive' }}
                            </div>
                        </td>
                        <td class="text-right">
                            <div class="row-actions" style="justify-content: flex-end;">
                                <a [routerLink]="['/admin/customers', customer.uid]" class="btn-icon-ghost"
                                    [title]="'ADMIN.COMMON.VIEW' | translate">
                                    üëÅÔ∏è
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <ng-template #noDataOrLoading>
            <div *ngIf="isLoading" class="glass-loader">
                <div class="spinner"></div>
                Loading Customers...
            </div>

            <div *ngIf="!isLoading && filteredCustomers.length === 0" class="empty-state">
                <span class="no-data">{{ 'ADMIN.CUSTOMERS.NO_RESULTS' | translate }}</span>
            </div>
        </ng-template>

        <!-- Pagination -->
        <div class="pagination-wrapper" *ngIf="filteredCustomers.length > 0">
            <app-pagination
                [config]="{ currentPage: currentPage, itemsPerPage: pageSize, totalItems: filteredCustomers.length }"
                (pageChange)="onPageChange($event)" (itemsPerPageChange)="pageSize = $event; currentPage = 1;">
            </app-pagination>
        </div>
    </main>
</div>