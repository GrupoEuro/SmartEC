<div class="product-dashboard-layout">
    <!-- Sticky Command Header -->
    <header class="command-header">
        <div class="header-left">
            <div class="header-title-section">
                <h1 class="page-title">{{ 'ADMIN.DISTRIBUTORS.TITLE' | translate }}</h1>
                <span class="product-badge" *ngIf="filteredDistributors.length > 0">{{ filteredDistributors.length
                    }}</span>
            </div>
            <!-- Subtitle removed to match products, or kept if preferred - removing for exact match -->
        </div>

        <div class="header-right" style="display: flex; gap: 12px; align-items: center;">
            <button class="btn-ghost" (click)="exportToCSV()" [disabled]="filteredDistributors.length === 0"
                title="{{ 'ADMIN.DISTRIBUTORS.EXPORT' | translate }}"
                style="color: #e4e4e7; background: #27272a; border: 1px solid #3f3f46; padding: 8px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span class="icon">üì•</span>
                <span class="text" style="font-size: 0.9rem;">{{ 'ADMIN.DISTRIBUTORS.EXPORT' | translate }}</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="product-grid-view">

        <!-- Unified Search & Filter Toolbar -->
        <div class="table-toolbar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()"
                    [placeholder]="'ADMIN.DISTRIBUTORS.SEARCH_PLACEHOLDER' | translate">
            </div>

            <!-- Status Filter disguised as generic filter -->
            <select class="filter-select" [(ngModel)]="statusFilter" (ngModelChange)="applyFilters()">
                <option value="all">{{ 'ADMIN.DISTRIBUTORS.FILTERS.ALL' | translate }}</option>
                <option value="new">{{ 'ADMIN.DISTRIBUTORS.FILTERS.NEW' | translate }}</option>
                <option value="contacted">{{ 'ADMIN.DISTRIBUTORS.FILTERS.CONTACTED' | translate }}</option>
                <option value="pending">{{ 'ADMIN.DISTRIBUTORS.FILTERS.PENDING' | translate }}</option>
                <option value="converted">{{ 'ADMIN.DISTRIBUTORS.FILTERS.CONVERTED' | translate }}</option>
                <option value="rejected">{{ 'ADMIN.DISTRIBUTORS.FILTERS.REJECTED' | translate }}</option>
            </select>

            <button class="btn-clear-filters" *ngIf="statusFilter !== 'all' || searchTerm"
                (click)="statusFilter = 'all'; searchTerm = ''; applyFilters()">
                Clear Filters
            </button>
        </div>

        <!-- Glass Table -->
        <div class="table-glass-container" *ngIf="!isLoading && filteredDistributors.length > 0; else noDataOrLoading">
            <table class="rich-table">
                <thead>
                    <tr>
                        <th class="w-12"></th> <!-- Expand Toggle -->
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.DATE' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.BUSINESS' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.CONTACT' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.LOCATIONS' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.VOLUME' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.STATUS' | translate }}</th>
                        <th class="text-right">{{ 'ADMIN.DISTRIBUTORS.TABLE.ACTIONS' | translate }}</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngFor="let distributor of paginatedDistributors; trackBy: trackById">
                        <tr [class.expanded-row]="expandedRowId === distributor.id">
                            <td class="expand-cell">
                                <button class="btn-icon-sm" (click)="toggleRow(distributor.id)">
                                    <span class="expand-arrow"
                                        [class.expanded]="expandedRowId === distributor.id">‚ñ∂</span>
                                </button>
                            </td>
                            <td class="date-cell">{{ distributor.createdAt | adminDate }}</td>
                            <td>
                                <div class="product-identity">
                                    <span class="product-name">{{ distributor.business }}</span>
                                    <span class="product-sku">{{ distributor.name }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="contact-info">
                                    <div class="email-row" title="Email">{{ distributor.email }}</div>
                                    <div class="phone-row" title="Phone">{{ distributor.phone }}</div>
                                </div>
                            </td>
                            <td>
                                <span class="category-badge" style="background: #64748b;">
                                    {{ distributor.state ? getStateName(distributor.state) : '-' }}
                                </span>
                            </td>
                            <td>{{ distributor.volume || '-' }}</td>
                            <td>
                                <div class="status-selector">
                                    <select [value]="distributor.status || 'new'"
                                        (change)="quickStatusChange(distributor, $any($event.target).value)"
                                        [class]="'status-badge ' + getStatusBadgeClass(distributor.status)"
                                        (click)="$event.stopPropagation()">
                                        <option value="new">{{ 'ADMIN.DISTRIBUTORS.STATUS.NEW' | translate }}</option>
                                        <option value="contacted">{{ 'ADMIN.DISTRIBUTORS.STATUS.CONTACTED' | translate
                                            }}</option>
                                        <option value="pending">{{ 'ADMIN.DISTRIBUTORS.STATUS.PENDING' | translate }}
                                        </option>
                                        <option value="converted">{{ 'ADMIN.DISTRIBUTORS.STATUS.APPROVED' | translate }}
                                        </option>
                                        <option value="rejected">{{ 'ADMIN.DISTRIBUTORS.STATUS.REJECTED' | translate }}
                                        </option>
                                    </select>
                                </div>
                            </td>
                            <td class="text-right">
                                <button class="btn-icon-ghost" (click)="openEditModal(distributor)"
                                    [title]="'ADMIN.COMMON.EDIT' | translate">
                                    ‚úèÔ∏è
                                </button>
                            </td>
                        </tr>

                        <!-- Expanded Details Row -->
                        <tr *ngIf="expandedRowId === distributor.id" class="details-row">
                            <td colspan="8">
                                <div class="expanded-content">
                                    <div class="details-grid">
                                        <div class="detail-card">
                                            <h4>{{ 'ADMIN.DISTRIBUTORS.DETAIL.LEAD_COMMENTS' | translate }}</h4>
                                            <p class="comment-text">{{ distributor.comments ||
                                                ('ADMIN.DISTRIBUTORS.DETAIL.NO_COMMENTS' | translate) }}</p>
                                        </div>

                                        <div class="detail-card">
                                            <h4>{{ 'ADMIN.DISTRIBUTORS.DETAIL.INTERNAL_NOTES' | translate }}</h4>
                                            <p class="note-text">{{ distributor.notes ||
                                                ('ADMIN.DISTRIBUTORS.DETAIL.NO_NOTES' | translate) }}</p>
                                        </div>

                                        <div *ngIf="distributor.contactedBy" class="detail-card full-width">
                                            <h4>{{ 'ADMIN.DISTRIBUTORS.DETAIL.CONTACT_HISTORY' | translate }}</h4>
                                            <div class="history-item">
                                                <span class="history-user" style="color: white; font-weight: 600;">{{
                                                    distributor.contactedBy }}</span>
                                                <span class="history-action"
                                                    style="color: var(--text-secondary); margin: 0 4px;">{{
                                                    'ADMIN.DISTRIBUTORS.DETAIL.UPDATED_BY' | translate }}</span>
                                                <span class="history-date" style="color: var(--primary-400);">{{
                                                    distributor.contactedAt | adminDate }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-container>
                </tbody>
            </table>
        </div>

        <ng-template #noDataOrLoading>
            <div *ngIf="isLoading" class="glass-loader">
                <div class="spinner"></div>
                Loading Distributors...
            </div>

            <div *ngIf="!isLoading && filteredDistributors.length === 0" class="empty-state">
                No distributors found matching your criteria.
            </div>
        </ng-template>

        <!-- Pagination -->
        <div class="pagination-wrapper" *ngIf="filteredDistributors.length > 0">
            <app-pagination [config]="paginationConfig" [translationPrefix]="'ADMIN.DISTRIBUTORS'"
                (pageChange)="onPageChange($event)" (itemsPerPageChange)="pageSize = $event; currentPage = 1;">
            </app-pagination>
        </div>

    </main>
</div>

<!-- Edit Modal -->
<div *ngIf="showEditModal && editingDistributor" class="modal-overlay" (click)="closeEditModal()">
    <div class="glass-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>{{ 'ADMIN.DISTRIBUTORS.MODAL.EDIT_TITLE' | translate }}</h2>
            <button class="btn-icon-ghost close-btn" (click)="closeEditModal()">‚úñ</button>
        </div>

        <div class="modal-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>{{ 'ADMIN.DISTRIBUTORS.MODAL.NAME' | translate }}</label>
                    <p>{{ editingDistributor.name }}</p>
                </div>
                <div class="info-item">
                    <label>{{ 'ADMIN.DISTRIBUTORS.MODAL.BUSINESS' | translate }}</label>
                    <p>{{ editingDistributor.business }}</p>
                </div>
                <div class="info-item">
                    <label>{{ 'ADMIN.DISTRIBUTORS.MODAL.EMAIL' | translate }}</label>
                    <p>{{ editingDistributor.email }}</p>
                </div>
                <div class="info-item">
                    <label>{{ 'ADMIN.DISTRIBUTORS.MODAL.PHONE' | translate }}</label>
                    <p>{{ editingDistributor.phone }}</p>
                </div>
                <div class="info-item">
                    <label>{{ 'ADMIN.DISTRIBUTORS.MODAL.STATE' | translate }}</label>
                    <p>{{ getStateName(editingDistributor.state) }}</p>
                </div>
                <div class="info-item">
                    <label>{{ 'ADMIN.DISTRIBUTORS.MODAL.VOLUME' | translate }}</label>
                    <p>{{ editingDistributor.volume }}</p>
                </div>
            </div>

            <div class="form-group">
                <label>{{ 'ADMIN.DISTRIBUTORS.DETAIL.LEAD_COMMENTS' | translate }}</label>
                <div class="readonly-text">{{ editingDistributor.comments || ('ADMIN.DISTRIBUTORS.DETAIL.NO_COMMENTS' |
                    translate) }}</div>
            </div>

            <div class="form-group">
                <label for="status">{{ 'ADMIN.DISTRIBUTORS.TABLE.STATUS' | translate }}</label>
                <select id="status" [(ngModel)]="editForm.status" class="glass-select">
                    <option value="new">{{ 'ADMIN.DISTRIBUTORS.STATUS.NEW' | translate }}</option>
                    <option value="contacted">{{ 'ADMIN.DISTRIBUTORS.STATUS.CONTACTED' | translate }}</option>
                    <option value="pending">{{ 'ADMIN.DISTRIBUTORS.STATUS.PENDING' | translate }}</option>
                    <option value="converted">{{ 'ADMIN.DISTRIBUTORS.STATUS.APPROVED' | translate }}</option>
                    <option value="rejected">{{ 'ADMIN.DISTRIBUTORS.STATUS.REJECTED' | translate }}</option>
                </select>
            </div>

            <div class="form-group">
                <label for="notes">{{ 'ADMIN.DISTRIBUTORS.DETAIL.INTERNAL_NOTES' | translate }}</label>
                <textarea id="notes" [(ngModel)]="editForm.notes"
                    [placeholder]="'ADMIN.DISTRIBUTORS.DETAIL.NOTE_PLACEHOLDER' | translate" rows="4"
                    class="glass-textarea"></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-ghost" (click)="closeEditModal()"
                style="border: 1px solid var(--border-medium); color: white;">{{ 'ADMIN.COMMON.CANCEL' | translate
                }}</button>
            <button class="btn-primary-action" (click)="saveEdit()">{{ 'ADMIN.COMMON.SAVE' | translate }}</button>
        </div>
    </div>
</div>