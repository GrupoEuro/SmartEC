<div class="product-dashboard-layout">
    <!-- Sticky Command Header -->
    <header class="command-header">
        <div class="header-left">
            <h1 class="page-title">{{ 'ADMIN.DISTRIBUTORS.TITLE' | translate }}</h1>
            <p class="page-subtitle">{{ 'ADMIN.DISTRIBUTORS.SUBTITLE' | translate }}</p>
        </div>
        <div class="header-actions">
            <button class="btn-glass" (click)="exportToCSV()" [disabled]="filteredDistributors.length === 0">
                <span class="icon">üì•</span>
                {{ 'ADMIN.DISTRIBUTORS.EXPORT' | translate }}
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="dashboard-content">

        <!-- Top Toolbar (Filters & Search) -->
        <div class="table-toolbar glass-panel">
            <div class="search-group">
                <span class="search-icon">üîç</span>
                <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()"
                    [placeholder]="'ADMIN.DISTRIBUTORS.SEARCH_PLACEHOLDER' | translate" class="glass-input" />
            </div>

            <div class="filter-group">
                <button class="filter-chip" [class.active]="statusFilter === 'all'"
                    (click)="statusFilter = 'all'; applyFilters()">
                    {{ 'ADMIN.DISTRIBUTORS.FILTERS.ALL' | translate }}
                </button>
                <button class="filter-chip" [class.active]="statusFilter === 'new'"
                    (click)="statusFilter = 'new'; applyFilters()">
                    {{ 'ADMIN.DISTRIBUTORS.FILTERS.NEW' | translate }}
                </button>
                <button class="filter-chip" [class.active]="statusFilter === 'contacted'"
                    (click)="statusFilter = 'contacted'; applyFilters()">
                    {{ 'ADMIN.DISTRIBUTORS.FILTERS.CONTACTED' | translate }}
                </button>
                <button class="filter-chip" [class.active]="statusFilter === 'pending'"
                    (click)="statusFilter = 'pending'; applyFilters()">
                    {{ 'ADMIN.DISTRIBUTORS.FILTERS.PENDING' | translate }}
                </button>
                <button class="filter-chip" [class.active]="statusFilter === 'converted'"
                    (click)="statusFilter = 'converted'; applyFilters()">
                    {{ 'ADMIN.DISTRIBUTORS.FILTERS.CONVERTED' | translate }}
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="loading-container">
            <div class="spinner"></div>
            <p class="loading-text">{{ 'ADMIN.COMMON.LOADING' | translate }}</p>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoading && filteredDistributors.length === 0" class="empty-state glass-panel">
            <div class="empty-icon">üìã</div>
            <h3>{{ 'ADMIN.DISTRIBUTORS.NO_RESULTS' | translate }}</h3>
            <p>{{ searchTerm ? ('ADMIN.COMMON.TRY_ADJUSTING_FILTERS' | translate) : ('ADMIN.DISTRIBUTORS.NO_LEADS_DESC'
                | translate) }}</p>
        </div>

        <!-- Glass Table -->
        <div *ngIf="!isLoading && filteredDistributors.length > 0" class="table-glass-container glass-panel">
            <table class="rich-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th> <!-- Expand Toggle -->
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.DATE' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.BUSINESS' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.CONTACT' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.LOCATIONS' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.VOLUME' | translate }}</th>
                        <th>{{ 'ADMIN.DISTRIBUTORS.TABLE.STATUS' | translate }}</th>
                        <th class="text-right">{{ 'ADMIN.DISTRIBUTORS.TABLE.ACTIONS' | translate }}</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngFor="let distributor of paginatedDistributors; trackBy: trackById">
                        <tr [class.expanded-row]="expandedRowId === distributor.id">
                            <td class="expand-cell">
                                <button class="btn-icon-sm" (click)="toggleRow(distributor.id)">
                                    <span class="expand-arrow"
                                        [class.expanded]="expandedRowId === distributor.id">‚ñ∂</span>
                                </button>
                            </td>
                            <td class="date-cell">{{ distributor.createdAt | adminDate }}</td>
                            <td>
                                <div class="business-info">
                                    <span class="business-name">{{ distributor.business }}</span>
                                    <span class="distributor-name">{{ distributor.name }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="contact-info">
                                    <div class="email-row" title="Email">{{ distributor.email }}</div>
                                    <div class="phone-row" title="Phone">{{ distributor.phone }}</div>
                                </div>
                            </td>
                            <td>
                                <span class="state-badge" [title]="getStateName(distributor.state)">
                                    {{ distributor.state || '-' }}
                                </span>
                            </td>
                            <td>{{ distributor.volume || '-' }}</td>
                            <td>
                                <div class="status-selector">
                                    <select [value]="distributor.status || 'new'"
                                        (change)="quickStatusChange(distributor, $any($event.target).value)"
                                        [class]="'status-badge ' + getStatusBadgeClass(distributor.status)"
                                        (click)="$event.stopPropagation()">
                                        <option value="new">{{ 'ADMIN.DISTRIBUTORS.STATUS.NEW' | translate }}</option>
                                        <option value="contacted">{{ 'ADMIN.DISTRIBUTORS.STATUS.CONTACTED' | translate
                                            }}</option>
                                        <option value="pending">{{ 'ADMIN.DISTRIBUTORS.STATUS.PENDING' | translate }}
                                        </option>
                                        <option value="converted">{{ 'ADMIN.DISTRIBUTORS.STATUS.APPROVED' | translate }}
                                        </option>
                                        <option value="rejected">{{ 'ADMIN.DISTRIBUTORS.STATUS.REJECTED' | translate }}
                                        </option>
                                    </select>
                                </div>
                            </td>
                            <td class="text-right">
                                <button class="btn-icon" (click)="openEditModal(distributor)"
                                    [title]="'ADMIN.COMMON.EDIT' | translate">
                                    ‚úèÔ∏è
                                </button>
                            </td>
                        </tr>

                        <!-- Expanded Details Row -->
                        <tr *ngIf="expandedRowId === distributor.id" class="details-row">
                            <td colspan="8">
                                <div class="expanded-content">
                                    <div class="details-grid">
                                        <div class="detail-card">
                                            <h4>Lead Comments</h4>
                                            <p class="comment-text">{{ distributor.comments || 'No comments provided.'
                                                }}</p>
                                        </div>

                                        <div class="detail-card">
                                            <h4>Internal Notes</h4>
                                            <p class="note-text">{{ distributor.notes || 'No internal notes.' }}</p>
                                        </div>

                                        <div *ngIf="distributor.contactedBy" class="detail-card full-width">
                                            <h4>Contact History</h4>
                                            <div class="history-item">
                                                <span class="history-user">{{ distributor.contactedBy }}</span>
                                                <span class="history-action">updated status on</span>
                                                <span class="history-date">{{ distributor.contactedAt | adminDate
                                                    }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-container>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-wrapper" *ngIf="filteredDistributors.length > 0">
            <app-pagination [config]="paginationConfig" [translationPrefix]="'ADMIN.DISTRIBUTORS'"
                (pageChange)="onPageChange($event)" (itemsPerPageChange)="pageSize = $event; currentPage = 1;">
            </app-pagination>
        </div>

    </div>
</div>

<!-- Edit Modal -->
<div *ngIf="showEditModal && editingDistributor" class="modal-overlay" (click)="closeEditModal()">
    <div class="glass-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Edit Lead Details</h2>
            <button class="btn-icon close-btn" (click)="closeEditModal()">‚úñ</button>
        </div>

        <div class="modal-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Name</label>
                    <p>{{ editingDistributor.name }}</p>
                </div>
                <div class="info-item">
                    <label>Business</label>
                    <p>{{ editingDistributor.business }}</p>
                </div>
                <div class="info-item">
                    <label>Email</label>
                    <p>{{ editingDistributor.email }}</p>
                </div>
                <div class="info-item">
                    <label>Phone</label>
                    <p>{{ editingDistributor.phone }}</p>
                </div>
                <div class="info-item">
                    <label>State</label>
                    <p>{{ getStateName(editingDistributor.state) }}</p>
                </div>
                <div class="info-item">
                    <label>Volume</label>
                    <p>{{ editingDistributor.volume }}</p>
                </div>
            </div>

            <div class="form-group">
                <label>Lead's Comments</label>
                <div class="readonly-text">{{ editingDistributor.comments || 'No comments' }}</div>
            </div>

            <div class="form-group">
                <label for="status">Status</label>
                <select id="status" [(ngModel)]="editForm.status" class="glass-select">
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="pending">Pending</option>
                    <option value="converted">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>

            <div class="form-group">
                <label for="notes">Internal Notes</label>
                <textarea id="notes" [(ngModel)]="editForm.notes" placeholder="Add notes about this lead..." rows="4"
                    class="glass-textarea"></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-glass" (click)="closeEditModal()">Cancel</button>
            <button class="btn-primary" (click)="saveEdit()">Save Changes</button>
        </div>
    </div>
</div>