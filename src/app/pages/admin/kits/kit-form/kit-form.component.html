<app-admin-page-header icon="üéÅ"
    [title]="(isEditMode ? 'ADMIN.KITS.FORM.TITLE_EDIT' : 'ADMIN.KITS.FORM.TITLE_NEW') | translate"
    [subtitle]="(isEditMode ? ('ADMIN.KITS.FORM.SUBTITLE_EDIT' | translate) : ('ADMIN.KITS.FORM.SUBTITLE_NEW' | translate))">
    <button type="button" class="btn-cancel" (click)="cancel()" [disabled]="isSaving()">
        {{ 'ADMIN.COMMON.CANCEL' | translate }}
    </button>
    <button type="submit" form="kitForm" class="btn-save" [disabled]="!canSave() || isSaving()">
        <span *ngIf="!isSaving()">
            üíæ {{ isEditMode ? ('ADMIN.COMMON.UPDATE' | translate) : ('ADMIN.COMMON.CREATE' | translate) }}
        </span>
        <span *ngIf="isSaving()">
            {{ 'ADMIN.COMMON.SAVING' | translate }}...
        </span>
    </button>
</app-admin-page-header>

<div class="form-container">
    <form [formGroup]="kitForm" (ngSubmit)="onSubmit()" id="kitForm">

        <!-- Basic Information -->
        <div class="form-section">
            <h3 class="section-title">
                <span class="section-icon">üì¶</span>
                {{ 'ADMIN.KITS.FORM.TAB_BASIC' | translate }}
            </h3>

            <div class="form-row" formGroupName="name">
                <div class="form-group">
                    <label for="nameEs">
                        {{ 'ADMIN.KITS.FORM.NAME_ES' | translate }} *
                        <span class="help-icon" title="Nombre del kit en Espa√±ol">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" id="nameEs" formControlName="es" class="form-control"
                        [placeholder]="'ADMIN.KITS.FORM.NAME_ES_PLACEHOLDER' | translate">
                    <div class="error"
                        *ngIf="kitForm.get('name')?.get('es')?.invalid && kitForm.get('name')?.get('es')?.touched">
                        {{ 'ADMIN.COMMON.FIELD_REQUIRED' | translate }}
                    </div>
                </div>
                <div class="form-group">
                    <label for="nameEn">
                        {{ 'ADMIN.KITS.FORM.NAME_EN' | translate }}
                        <span class="help-icon" title="Kit name in English">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" id="nameEn" formControlName="en" class="form-control"
                        [placeholder]="'ADMIN.KITS.FORM.NAME_EN_PLACEHOLDER' | translate">
                </div>
            </div>

            <div class="form-group">
                <label for="sku">
                    {{ 'ADMIN.KITS.FORM.SKU' | translate }} *
                    <span class="help-icon" title="Unique kit identifier">‚ÑπÔ∏è</span>
                </label>
                <input type="text" id="sku" formControlName="sku" class="form-control"
                    [placeholder]="'ADMIN.KITS.FORM.SKU_PLACEHOLDER' | translate">
                <small class="form-hint">{{ 'ADMIN.KITS.FORM.SKU_HINT' | translate }}</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="descEs">{{ 'ADMIN.KITS.FORM.DESC_ES' | translate }}</label>
                    <textarea id="descEs" formGroupName="description" formControlName="es" class="form-control" rows="3"
                        [placeholder]="'ADMIN.KITS.FORM.DESC_ES_PLACEHOLDER' | translate"></textarea>
                </div>
                <div class="form-group">
                    <label for="descEn">{{ 'ADMIN.KITS.FORM.DESC_EN' | translate }}</label>
                    <textarea id="descEn" formGroupName="description" formControlName="en" class="form-control" rows="3"
                        [placeholder]="'ADMIN.KITS.FORM.DESC_EN_PLACEHOLDER' | translate"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label for="image">{{ 'ADMIN.KITS.FORM.IMAGE' | translate }}</label>
                <input type="text" id="image" formControlName="image" class="form-control"
                    [placeholder]="'ADMIN.KITS.FORM.IMAGE_PLACEHOLDER' | translate">
                <small class="form-hint">{{ 'ADMIN.KITS.FORM.IMAGE_HINT' | translate }}</small>
            </div>

            <!-- Visibility Settings Card -->
            <div class="toggle-group-card">
                <h4 class="card-title">
                    <span class="card-icon">üéØ</span>
                    {{ 'ADMIN.KITS.FORM.VISIBILITY_SETTINGS' | translate }}
                </h4>
                <div class="toggle-switches-group">
                    <div class="form-group">
                        <app-toggle-switch [control]="$any(kitForm.get('featured'))"
                            [label]="'ADMIN.KITS.FORM.FEATURED' | translate" icon="‚≠ê"
                            [hint]="'ADMIN.KITS.FORM.FEATURED_HINT' | translate">
                        </app-toggle-switch>
                    </div>
                    <div class="form-group">
                        <app-toggle-switch [control]="$any(kitForm.get('active'))"
                            [label]="'ADMIN.KITS.FORM.ACTIVE' | translate" icon="‚úÖ"
                            [hint]="'ADMIN.KITS.FORM.ACTIVE_HINT' | translate">
                        </app-toggle-switch>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="publishStatus">{{ 'ADMIN.KITS.FORM.PUBLISH_STATUS' | translate }}</label>
                <select id="publishStatus" formControlName="publishStatus" class="form-control">
                    <option value="draft">üìù {{ 'ADMIN.KITS.FORM.DRAFT' | translate }}</option>
                    <option value="published">‚úÖ {{ 'ADMIN.KITS.FORM.PUBLISHED' | translate }}</option>
                    <option value="archived">üì¶ {{ 'ADMIN.KITS.FORM.ARCHIVED' | translate }}</option>
                </select>
            </div>
        </div>

        <!-- Components Section -->
        <div class="form-section">
            <div class="section-header">
                <h3 class="section-title">
                    <span class="section-icon">üß©</span>
                    {{ 'ADMIN.KITS.FORM.TAB_COMPONENTS' | translate }}
                    <span class="component-count">({{ components.length }})</span>
                </h3>
                <button type="button" class="btn-add-feature" (click)="showProductPicker.set(true)">
                    + {{ 'ADMIN.KITS.FORM.ADD_COMPONENT' | translate }}
                </button>
            </div>

            <!-- Components List -->
            <div class="components-list" formArrayName="components">
                <div *ngFor="let comp of components.controls; let i = index" [formGroupName]="i" class="component-item">
                    <img [src]="comp.value.productImage" [alt]="comp.value.productName" class="component-image">
                    <div class="component-info">
                        <div class="component-name">{{ comp.value.productName }}</div>
                        <div class="component-sku">SKU: {{ comp.value.sku }}</div>
                    </div>
                    <div class="component-quantity">
                        <label>{{ 'ADMIN.KITS.FORM.COMPONENT_QTY' | translate }}</label>
                        <input type="number" formControlName="quantity" class="qty-input" min="1">
                    </div>
                    <button type="button" class="btn-remove" (click)="removeComponent(i)" title="Remove">
                        ‚úï
                    </button>
                </div>

                <div *ngIf="components.length === 0" class="empty-components">
                    <span class="empty-icon">üì¶</span>
                    <p>{{ 'ADMIN.KITS.FORM.NO_COMPONENTS' | translate }}</p>
                    <small>{{ 'ADMIN.KITS.FORM.NO_COMPONENTS_HINT' | translate }}</small>
                </div>
            </div>
        </div>

        <!-- Pricing Section -->
        <div class="form-section">
            <h3 class="section-title">
                <span class="section-icon">üí∞</span>
                {{ 'ADMIN.KITS.FORM.TAB_PRICING' | translate }}
            </h3>

            <div class="pricing-summary">
                <div class="pricing-row">
                    <span>{{ 'ADMIN.KITS.FORM.COMPONENTS_TOTAL' | translate }}:</span>
                    <strong>{{ totalComponentPrice() | currency }}</strong>
                </div>
                <div class="pricing-row">
                    <span>{{ 'ADMIN.KITS.FORM.KIT_PRICE' | translate }}:</span>
                    <strong>{{ kitForm.get('price')?.value | currency }}</strong>
                </div>
                <div class="pricing-row savings" *ngIf="savingsAmount() > 0">
                    <span>üí∞ {{ 'ADMIN.KITS.FORM.SAVINGS_AUTO' | translate }}:</span>
                    <strong class="savings-value">
                        {{ savingsAmount() | currency }} ({{ getSavingsPercentage() }}%)
                    </strong>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="price">
                        {{ 'ADMIN.KITS.FORM.KIT_PRICE' | translate }} (MXN) *
                        <span class="help-icon" title="Precio final del kit">‚ÑπÔ∏è</span>
                    </label>
                    <div class="input-with-prefix">
                        <span class="currency-prefix">$</span>
                        <input type="number" id="price" formControlName="price" class="form-control with-prefix" min="0"
                            step="0.01" placeholder="0.00">
                        <span class="currency-suffix">MXN</span>
                    </div>
                    <small class="form-hint">{{ 'ADMIN.KITS.FORM.KIT_PRICE_HINT' | translate }}</small>
                </div>

                <div class="form-group">
                    <label for="compareAtPrice">
                        {{ 'ADMIN.KITS.FORM.COMPARE_PRICE' | translate }} (MXN)
                        <span class="help-icon" title="Precio original para mostrar descuento">‚ÑπÔ∏è</span>
                    </label>
                    <div class="input-with-prefix">
                        <span class="currency-prefix">$</span>
                        <input type="number" id="compareAtPrice" formControlName="compareAtPrice"
                            class="form-control with-prefix" min="0" step="0.01" placeholder="0.00">
                        <span class="currency-suffix">MXN</span>
                    </div>
                    <small class="form-hint">{{ 'ADMIN.KITS.FORM.COMPARE_PRICE_HINT' | translate }}</small>
                </div>
            </div>

            <!-- Savings Alert -->
            <div class="stock-success" *ngIf="savingsAmount() > 0">
                <div class="success-header">
                    <span class="success-icon">üí∞</span>
                    <strong>{{ 'ADMIN.KITS.FORM.SAVINGS_ALERT_TITLE' | translate }}</strong>
                </div>
                <p class="success-text">
                    {{ 'ADMIN.KITS.FORM.SAVINGS_ALERT_TEXT' | translate:{ amount: (savingsAmount() | currency),
                    percentage: getSavingsPercentage() } }}
                </p>
            </div>
        </div>

        <!-- SEO Section -->
        <div class="form-section seo-section">
            <h3 class="section-title">
                <span class="section-icon">üîç</span>
                {{ 'ADMIN.KITS.FORM.TAB_SEO' | translate }}
            </h3>

            <div formGroupName="seo">
                <div class="form-group">
                    <label for="metaTitle">
                        {{ 'ADMIN.KITS.FORM.META_TITLE' | translate }}
                        <span class="help-icon" [title]="'ADMIN.KITS.FORM.META_TITLE_HELP' | translate">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" id="metaTitle" formControlName="metaTitle" class="form-control" maxlength="70"
                        [placeholder]="'ADMIN.KITS.FORM.META_TITLE_PLACEHOLDER' | translate">
                    <small class="form-hint">{{ 'ADMIN.KITS.FORM.META_TITLE_HINT' | translate }}</small>
                </div>

                <div class="form-group">
                    <label for="metaDescription">
                        {{ 'ADMIN.KITS.FORM.META_DESCRIPTION' | translate }}
                        <span class="help-icon" [title]="'ADMIN.KITS.FORM.META_DESC_HELP' | translate">‚ÑπÔ∏è</span>
                    </label>
                    <textarea id="metaDescription" formControlName="metaDescription" class="form-control" rows="3"
                        maxlength="170" [placeholder]="'ADMIN.KITS.FORM.META_DESC_PLACEHOLDER' | translate"></textarea>
                    <small class="form-hint">{{ 'ADMIN.KITS.FORM.META_DESC_HINT' | translate }}</small>
                </div>
            </div>
        </div>

    </form>
</div>

<!-- Product Picker Modal -->
<div class="modal-overlay" *ngIf="showProductPicker()" (click)="showProductPicker.set(false)">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>{{ 'ADMIN.KITS.FORM.ADD_COMPONENT' | translate }}</h3>
            <button class="btn-close" (click)="showProductPicker.set(false)">√ó</button>
        </div>
        <div class="modal-body">
            <input type="text" class="search-input" [placeholder]="'ADMIN.KITS.FORM.SEARCH_PRODUCTS' | translate"
                [value]="searchTerm()" (input)="searchTerm.set($any($event.target).value)">

            <div class="product-list">
                <div *ngFor="let product of filteredProducts()" class="product-item" (click)="addProduct(product)">
                    <img [src]="product.images.main" [alt]="product.name.es" class="product-thumb">
                    <div class="product-details">
                        <div class="product-name">{{ product.name.es }}</div>
                        <div class="product-sku">{{ product.sku }}</div>
                    </div>
                    <div class="product-price">{{ product.price | currency }}</div>
                </div>

                <div *ngIf="filteredProducts().length === 0" class="empty-products">
                    <p>{{ 'ADMIN.KITS.FORM.NO_PRODUCTS_FOUND' | translate }}</p>
                </div>
            </div>
        </div>
    </div>
</div>