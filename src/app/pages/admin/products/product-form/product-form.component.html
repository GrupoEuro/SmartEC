<app-admin-page-header icon="üõí"
    [title]="isEditing ? ('ADMIN.PRODUCTS.EDIT_TITLE' | translate) : ('ADMIN.PRODUCTS.NEW_TITLE' | translate)"
    [subtitle]="isEditing ? ('ADMIN.PRODUCTS.EDIT_SUBTITLE' | translate) : ('ADMIN.PRODUCTS.NEW_SUBTITLE' | translate)">
    <button type="button" class="btn-secondary" (click)="onCancel()">
        {{ 'ADMIN.COMMON.CANCEL' | translate }}
    </button>
</app-admin-page-header>

<div class="form-container">
    <app-validation-summary [form]="productForm" [fieldLabels]="fieldLabels"></app-validation-summary>

    <form *ngIf="productForm" [formGroup]="productForm" (ngSubmit)="onSubmit()">

        <!-- Basic Information -->
        <section class="form-section">
            <h3 class="section-title">Basic Information</h3>

            <div class="form-row cols-2">
                <div class="form-group">
                    <label for="nameEn">
                        Product Name (English) <span class="required">*</span>
                    </label>
                    <input type="text" id="nameEn" formControlName="nameEn" class="form-control"
                        placeholder="Enter product name in English">
                    <div class="error" *ngIf="productForm.get('nameEn')?.invalid && productForm.get('nameEn')?.touched">
                        This field is required
                    </div>
                </div>

                <div class="form-group">
                    <label for="nameEs">
                        Product Name (Spanish) <span class="required">*</span>
                    </label>
                    <input type="text" id="nameEs" formControlName="nameEs" class="form-control"
                        placeholder="Ingresa el nombre del producto en Espa√±ol">
                    <div class="error" *ngIf="productForm.get('nameEs')?.invalid && productForm.get('nameEs')?.touched">
                        This field is required
                    </div>
                </div>
            </div>

            <div class="form-row cols-2">
                <div class="form-group">
                    <label for="brand">Brand <span class="required">*</span></label>
                    <select id="brand" formControlName="brand" class="form-control">
                        <option value="">Select a brand</option>
                        <option *ngFor="let brand of brands" [value]="brand">{{ brand }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="categoryId">Category <span class="required">*</span></label>
                    <select id="categoryId" formControlName="categoryId" class="form-control">
                        <option value="">Select a category</option>
                        <option *ngFor="let category of categories" [value]="category.id">
                            {{ category.name.es }}
                        </option>
                    </select>
                </div>
            </div>

            <div class="form-row cols-2">
                <div class="form-group">
                    <label for="sku">
                        SKU <span class="required">*</span>
                        <span class="help-icon" title="Auto-generated from specifications">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" id="sku" formControlName="sku" class="form-control">
                    <small class="form-hint">Auto-generated from tire specifications</small>
                </div>

                <div class="form-group">
                    <label for="slug">
                        URL Slug <span class="required">*</span>
                        <span class="help-icon" title="Used in product URL">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" id="slug" formControlName="slug" class="form-control">
                    <small class="form-hint">Used in product URL: /products/[slug]</small>
                </div>
            </div>
        </section>

        <!-- Product Type Selection -->
        <section class="form-section">
            <h3 class="section-title">
                <span class="section-icon">üéØ</span>
                Product Type
            </h3>

            <div class="product-type-selector">
                <div *ngFor="let type of availableProductTypes" class="type-card"
                    [class.selected]="selectedProductType === type.id"
                    (click)="productForm.patchValue({ productType: type.id })">
                    <span class="type-icon">{{ type.icon }}</span>
                    <span class="type-name">{{ type.name.en }}</span>
                </div>
            </div>
        </section>

        <!-- Dynamic Specifications -->
        <section class="form-section" *ngIf="currentSpecSchema.length > 0" formGroupName="specifications">
            <h3 class="section-title">
                <span class="section-icon">üîß</span>
                Specifications
            </h3>

            <div class="form-row cols-3">
                <div class="form-group" *ngFor="let field of currentSpecSchema">
                    <label [for]="field.key">
                        {{ field.label.en }}
                        <span *ngIf="field.required" class="required">*</span>
                        <span *ngIf="field.unit" class="unit">({{ field.unit }})</span>
                    </label>

                    <!-- Text Input -->
                    <input *ngIf="field.type === 'text'" [id]="field.key" type="text" [formControlName]="field.key"
                        class="form-control" [placeholder]="'Enter ' + field.label.en">

                    <!-- Number Input -->
                    <input *ngIf="field.type === 'number'" [id]="field.key" type="number" [formControlName]="field.key"
                        [min]="field.min ?? null" [max]="field.max ?? null" class="form-control"
                        [placeholder]="'Enter ' + field.label.en">

                    <!-- Select Input -->
                    <select *ngIf="field.type === 'select'" [id]="field.key" [formControlName]="field.key"
                        class="form-control">
                        <option value="">Select {{ field.label.en }}</option>
                        <option *ngFor="let opt of field.options" [value]="opt">
                            {{ opt }}
                        </option>
                    </select>

                    <!-- Boolean Toggle -->
                    <div *ngIf="field.type === 'boolean'" class="toggle-wrapper">
                        <app-toggle-switch [control]="$any(productForm.get('specifications.' + field.key))"
                            [label]="field.label.en">
                        </app-toggle-switch>
                    </div>
                </div>
            </div>
        </section>

        <!-- Descriptions -->
        <section class="form-section">
            <h3 class="section-title">Descriptions</h3>

            <div class="form-row">
                <div class="form-group">
                    <label for="descriptionEn">Description (English)</label>
                    <textarea id="descriptionEn" formControlName="descriptionEn" class="form-control" rows="5"
                        placeholder="Detailed product description in English..."></textarea>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="descriptionEs">Description (Spanish)</label>
                    <textarea id="descriptionEs" formControlName="descriptionEs" class="form-control" rows="5"
                        placeholder="Descripci√≥n detallada del producto en Espa√±ol..."></textarea>
                </div>
            </div>
        </section>

        <!-- Features -->
        <section class="form-section">
            <h3 class="section-title">Features</h3>

            <div class="form-row">
                <div class="form-group">
                    <label>Features (English)</label>
                    <div class="feature-list" formArrayName="featuresEn">
                        <div *ngFor="let feature of featuresEn.controls; let i = index" class="feature-item">
                            <input type="text" [formControlName]="i" class="form-control"
                                placeholder="Enter feature in English">
                            <button type="button" class="btn-remove" (click)="removeFeature('en', i)">‚úï</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-add-feature" (click)="addFeature('en')">
                        + Add Feature (EN)
                    </button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Features (Spanish)</label>
                    <div class="feature-list" formArrayName="featuresEs">
                        <div *ngFor="let feature of featuresEs.controls; let i = index" class="feature-item">
                            <input type="text" [formControlName]="i" class="form-control"
                                placeholder="Ingresa caracter√≠stica en Espa√±ol">
                            <button type="button" class="btn-remove" (click)="removeFeature('es', i)">‚úï</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-add-feature" (click)="addFeature('es')">
                        + Add Feature (ES)
                    </button>
                </div>
            </div>
        </section>

        <!-- Product Images -->
        <section class="form-section">
            <h3 class="section-title">Product Images</h3>

            <div class="image-actions">
                <button type="button" class="btn-upload" (click)="imageInput.click()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    <span>Upload Images</span>
                </button>

                <button type="button" class="btn-library" (click)="openMediaLibrary()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" />
                        <polyline points="21 15 16 10 5 21" />
                    </svg>
                    <span>Choose from Library</span>
                </button>
            </div>

            <div class="images-grid" cdkDropList (cdkDropListDropped)="onImageReorder($event)">
                <div *ngFor="let img of productImages; let i = index" class="image-card" cdkDrag>

                    <span class="main-badge" *ngIf="i === 0">MAIN</span>

                    <div class="image-container-16x9">
                        <img [src]="img.url" [alt]="'Product image ' + (i+1)">
                    </div>

                    <button type="button" class="btn-remove-card" (click)="removeImage(i)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>

                    <div class="drag-indicator">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="9" cy="5" r="1" fill="currentColor" />
                            <circle cx="9" cy="12" r="1" fill="currentColor" />
                            <circle cx="9" cy="19" r="1" fill="currentColor" />
                            <circle cx="15" cy="5" r="1" fill="currentColor" />
                            <circle cx="15" cy="12" r="1" fill="currentColor" />
                            <circle cx="15" cy="19" r="1" fill="currentColor" />
                        </svg>
                    </div>
                </div>
            </div>

            <p class="helper-text" *ngIf="productImages.length > 0">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z" />
                    <path d="M2 17l10 5 10-5" />
                    <path d="M2 12l10 5 10-5" />
                </svg>
                Drag to reorder ‚Ä¢ First image is the main
            </p>

            <input #imageInput type="file" multiple accept="image/*" (change)="onImagesSelected($event)"
                style="display: none;">
        </section>

        <!-- Pricing & Stock -->
        <section class="form-section">
            <h3 class="section-title">Pricing & Stock</h3>

            <div class="form-row cols-2">
                <div class="form-group">
                    <label for="price">
                        Price (MXN) <span class="required">*</span>
                        <span class="help-icon" title="Regular selling price">‚ÑπÔ∏è</span>
                    </label>
                    <div class="input-with-prefix">
                        <span class="currency-prefix">$</span>
                        <input type="number" id="price" formControlName="price" min="0" step="0.01"
                            class="form-control with-prefix" placeholder="0.00">
                        <span class="currency-suffix">MXN</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="compareAtPrice">
                        Compare at Price (MXN)
                        <span class="help-icon" title="Original price before discount">‚ÑπÔ∏è</span>
                    </label>
                    <div class="input-with-prefix">
                        <span class="currency-prefix">$</span>
                        <input type="number" id="compareAtPrice" formControlName="compareAtPrice" min="0" step="0.01"
                            class="form-control with-prefix" placeholder="0.00">
                        <span class="currency-suffix">MXN</span>
                    </div>
                    <small class="form-hint">Shows savings to customers if higher than price</small>
                </div>
            </div>

            <div class="form-row cols-2">
                <div class="form-group">
                    <label for="stockQuantity">
                        Stock Quantity <span class="required">*</span>
                        <span class="help-icon" title="Available units in inventory">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="stockQuantity" formControlName="stockQuantity" min="0"
                        class="form-control">

                    <div class="stock-warning"
                        *ngIf="productForm.get('stockQuantity')?.value > 0 && productForm.get('stockQuantity')?.value < 5">
                        <div class="warning-header">
                            <span class="warning-icon">‚ö†Ô∏è</span>
                            <strong>Low Stock Alert</strong>
                        </div>
                        <p class="warning-text">
                            Only <strong>{{ productForm.get('stockQuantity')?.value }}</strong> unit(s) remaining.
                        </p>
                    </div>

                    <div class="stock-alert" *ngIf="productForm.get('stockQuantity')?.value === 0">
                        <div class="alert-header">
                            <span class="alert-icon">üö´</span>
                            <strong>Out of Stock</strong>
                        </div>
                        <p class="alert-text">
                            Product will be marked as unavailable
                        </p>
                    </div>
                </div>

                <div class="form-group">
                    <app-toggle-switch [control]="$any(productForm.get('inStock'))" label="In Stock" icon="üì¶">
                    </app-toggle-switch>
                </div>
            </div>
        </section>

        <!-- Marketing & SEO -->
        <section class="form-section">
            <h3 class="section-title">Marketing & SEO</h3>

            <!-- SEO Score Indicator -->
            <div class="seo-score-card" *ngIf="metaTitleLength > 0 || metaDescriptionLength > 0">
                <div class="score-header">
                    <span class="score-icon">üìä</span>
                    <div class="score-details">
                        <h4 class="score-title">SEO Quality Score</h4>
                        <p class="score-subtitle">Based on meta title and description</p>
                    </div>
                    <div class="score-badge" [ngClass]="{
                        'excellent': seoScore >= 80,
                        'good': seoScore >= 60 && seoScore < 80,
                        'fair': seoScore >= 40 && seoScore < 60,
                        'poor': seoScore < 40
                    }">
                        <span class="score-value">{{ seoScore }}</span>
                        <span class="score-label">{{ seoQualityLabel }}</span>
                    </div>
                </div>
            </div>

            <!-- Meta Title -->
            <div class="form-row">
                <div class="form-group">
                    <label for="metaTitle">
                        SEO Meta Title
                        <span class="help-icon" title="This appears in search results and browser tabs">‚ÑπÔ∏è</span>
                    </label>

                    <div class="info-card">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="16" x2="12" y2="12" />
                            <line x1="12" y1="8" x2="12.01" y2="8" />
                        </svg>
                        <div class="info-content">
                            <strong>What is this?</strong> The title that appears in search engine results. Make it
                            compelling and include your main keyword.
                        </div>
                    </div>

                    <input type="text" id="metaTitle" formControlName="metaTitle" class="form-control"
                        placeholder="e.g., Praxis 205/55R16 High Performance Tire - Premium Quality">

                    <div class="field-footer">
                        <small class="form-hint">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                            </svg>
                            Sample: "{{ productForm.get('nameEn')?.value || 'Product Name' }} | {{
                            productForm.get('brand')?.value || 'Brand' }} Official Store"
                        </small>
                        <div class="character-counter" [ngClass]="{
                            'optimal': metaTitleOptimal,
                            'warning': metaTitleLength > 0 && !metaTitleOptimal,
                            'empty': metaTitleLength === 0
                        }">
                            <span class="counter-value">{{ metaTitleLength }}</span>
                            <span class="counter-separator">/</span>
                            <span class="counter-target">50-60</span>
                            <span class="counter-status" *ngIf="metaTitleOptimal">‚úì</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Meta Description -->
            <div class="form-row">
                <div class="form-group">
                    <label for="metaDescription">
                        SEO Meta Description
                        <span class="help-icon"
                            title="The description shown under your title in search results">‚ÑπÔ∏è</span>
                    </label>

                    <div class="info-card">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="16" x2="12" y2="12" />
                            <line x1="12" y1="8" x2="12.01" y2="8" />
                        </svg>
                        <div class="info-content">
                            <strong>What is this?</strong> A concise summary that appears below the title in search
                            results. Entice users to click!
                        </div>
                    </div>

                    <textarea id="metaDescription" formControlName="metaDescription" class="form-control" rows="3"
                        placeholder="e.g., High-performance tire designed for exceptional grip and durability. Suitable for all weather conditions. Free shipping on orders over $500."></textarea>

                    <div class="field-footer">
                        <small class="form-hint">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                            </svg>
                            Include: Product specs, benefits, and a call-to-action (e.g., "Free shipping", "Best price")
                        </small>
                        <div class="character-counter" [ngClass]="{
                            'optimal': metaDescriptionOptimal,
                            'warning': metaDescriptionLength > 0 && !metaDescriptionOptimal,
                            'empty': metaDescriptionLength === 0
                        }">
                            <span class="counter-value">{{ metaDescriptionLength }}</span>
                            <span class="counter-separator">/</span>
                            <span class="counter-target">150-160</span>
                            <span class="counter-status" *ngIf="metaDescriptionOptimal">‚úì</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Preview -->
            <div class="search-preview" *ngIf="metaTitleLength > 0 || metaDescriptionLength > 0">
                <div class="preview-header">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                    </svg>
                    <span>Search Result Preview</span>
                </div>
                <div class="preview-card">
                    <div class="preview-url">example.com ‚Ä∫ products ‚Ä∫ {{ productForm.get('slug')?.value ||
                        'product-slug' }}</div>
                    <div class="preview-title">{{ productForm.get('metaTitle')?.value ||
                        productForm.get('nameEn')?.value || 'Product Title' }}</div>
                    <div class="preview-description">{{ productForm.get('metaDescription')?.value || 'No description
                        provided yet...' }}</div>
                </div>
            </div>

            <!-- Featured Product Toggle -->
            <div class="form-row">
                <div class="form-group">
                    <app-toggle-switch [control]="$any(productForm.get('featured'))" label="Featured Product" icon="‚≠ê">
                    </app-toggle-switch>
                    <small class="form-hint toggle-hint">Featured products appear in special sections on the
                        homepage</small>
                </div>
            </div>

            <!-- New Arrival Toggle -->
            <div class="form-row">
                <div class="form-group">
                    <app-toggle-switch [control]="$any(productForm.get('isNewArrival'))" label="New Arrival" icon="üÜï">
                    </app-toggle-switch>
                    <small class="form-hint toggle-hint">Mark as new arrival to highlight recent additions</small>
                </div>
            </div>

            <!-- Best Seller Toggle -->
            <div class="form-row">
                <div class="form-group">
                    <app-toggle-switch [control]="$any(productForm.get('isBestSeller'))" label="Best Seller" icon="üî•">
                    </app-toggle-switch>
                    <small class="form-hint toggle-hint">Highlight top-selling products</small>
                </div>
            </div>

            <!-- Active/Visible Toggle -->
            <div class="form-row">
                <div class="form-group">
                    <app-toggle-switch [control]="$any(productForm.get('active'))" label="Active (Visible)" icon="‚úÖ">
                    </app-toggle-switch>
                    <small class="form-hint toggle-hint">Control product visibility on the storefront</small>
                </div>
            </div>
        </section>


        <!-- Submit Actions -->
        <div class="submit-actions">
            <!-- Error Message Display -->
            <div class="submit-error-message" *ngIf="submitState === 'error' && errorMessage">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
                <span>{{ errorMessage }}</span>
            </div>

            <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="isSubmitting">
                Cancel
            </button>

            <button type="submit" class="btn btn-primary" [disabled]="productForm.invalid || isSubmitting" [ngClass]="{
                    'loading': submitState === 'validating' || submitState === 'uploading' || submitState === 'saving',
                    'success': submitState === 'success',
                    'error': submitState === 'error'
                }">

                <!-- Idle State -->
                <span *ngIf="submitState === 'idle'">
                    {{ isEditing ? 'Update Product' : 'Create Product' }}
                </span>

                <!-- Validating State -->
                <span *ngIf="submitState === 'validating'" class="btn-state-content">
                    <span class="spinner"></span>
                    Validating...
                </span>

                <!-- Uploading State -->
                <span *ngIf="submitState === 'uploading'" class="btn-state-content">
                    <span class="spinner"></span>
                    Uploading Images...
                </span>

                <!-- Saving State -->
                <span *ngIf="submitState === 'saving'" class="btn-state-content">
                    <span class="spinner"></span>
                    Saving...
                </span>

                <!-- Success State -->
                <span *ngIf="submitState === 'success'" class="btn-state-content">
                    <svg class="checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="3">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                    Saved!
                </span>

                <!-- Error State -->
                <span *ngIf="submitState === 'error'" class="btn-state-content">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="15" y1="9" x2="9" y2="15" />
                        <line x1="9" y1="9" x2="15" y2="15" />
                    </svg>
                    Failed
                </span>
            </button>
        </div>


    </form>
</div>

<!-- Media Library Dialog -->
<app-media-picker-dialog *ngIf="showMediaPicker" (assetSelected)="onMediaAssetSelected($event)"
    (close)="closeMediaPicker()">
</app-media-picker-dialog>