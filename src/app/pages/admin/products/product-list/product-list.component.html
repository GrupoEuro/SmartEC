<div class="product-dashboard-layout">

    <header class="command-header">
        <div class="header-left">
            <div class="header-title-section">
                <h1 class="page-title">{{ 'ADMIN.PRODUCTS.TITLE' | translate }}</h1>
                <span class="product-badge" *ngIf="(displayedProducts$ | async) as products">{{
                    paginationConfig.totalItems }}</span>
            </div>
        </div>

        <div class="header-right">
            <button class="btn-primary-action" routerLink="/admin/products/new">
                <span class="icon">‚ûï</span>
                <span class="text">{{ 'ADMIN.PRODUCTS.BTN_ADD' | translate }}</span>
            </button>
        </div>
    </header>

    <!-- Full Width Main Area (No Sidebar) -->
    <main class="product-grid-view">


        <!-- Unified Search & Filter Toolbar -->
        <div class="table-toolbar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()"
                    placeholder="Search by name, brand, or SKU...">
            </div>
            <select class="filter-select" [(ngModel)]="selectedCategory" (ngModelChange)="onFilterChange()">
                <option value="">All Categories</option>
                <option *ngFor="let cat of categories$ | async" [value]="cat.id">{{ cat.name.en }}</option>
            </select>
            <select class="filter-select" [(ngModel)]="selectedStockStatus" (ngModelChange)="onFilterChange()">
                <option value="">All Stock</option>
                <option value="in-stock">In Stock</option>
                <option value="low-stock">Low Stock</option>
                <option value="out-of-stock">Out of Stock</option>
            </select>
            <button class="btn-clear-filters" *ngIf="selectedCategory || selectedStockStatus" (click)="resetFilters()">
                Clear Filters
            </button>
        </div>

        <!-- Bulk Actions Bar (Conditional) -->
        <div class="bulk-actions-barglass" *ngIf="selectedCount > 0">
            <span class="selected-text">{{ selectedCount }} selected</span>
            <div class="actions">
                <button (click)="bulkActivate()">Activate</button>
                <button (click)="bulkDeactivate()">Deactivate</button>
                <button class="danger" (click)="bulkDelete()">Delete</button>
            </div>
        </div>

        <div class="table-glass-container" *ngIf="(displayedProducts$ | async) as products; else loading">
            <table class="rich-table">
                <thead>
                    <!-- Column Headers -->
                    <tr>
                        <th class="w-12">
                            <input type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll(products)">
                        </th>
                        <th class="w-20">{{ 'ADMIN.PRODUCTS.TH_IMAGE' | translate }}</th>
                        <th class="sortable" (click)="onSortChange('name')">
                            Product Details <span *ngIf="sortField === 'name'">{{ sortDirection === 'asc' ? '‚ñ≤' :
                                '‚ñº' }}</span>
                        </th>
                        <th>Category</th>
                        <th class="sortable text-right" (click)="onSortChange('price')">
                            Price <span *ngIf="sortField === 'price'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'
                                }}</span>
                        </th>
                        <th class="sortable" (click)="onSortChange('stock')">
                            Stock Status <span *ngIf="sortField === 'stock'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'
                                }}</span>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let product of products" [class.selected]="isProductSelected(product.id)">
                        <td>
                            <input type="checkbox" *ngIf="product.id" [checked]="isProductSelected(product.id)"
                                (change)="toggleProductSelection(product.id)">
                        </td>
                        <td>
                            <div class="img-thumbnail">
                                <img [src]="product.images.main || 'https://firebasestorage.googleapis.com/v0/b/tiendapraxis.firebasestorage.app/o/media%2Fproducts%2F1768533545145_zdh9yl.jpg?alt=media&token=968a5d90-cd5a-4d34-bf77-36472d0376c3'"
                                    [alt]="product.name.en">
                            </div>
                        </td>
                        <td>
                            <div class="product-identity">
                                <span class="product-name" [routerLink]="['/admin/products', product.id, 'edit']">{{
                                    product.name.en }}</span>
                                <span class="product-sku">{{ product.sku }} ‚Ä¢ {{ product.brand }}</span>
                                <div class="badges-row">
                                    <span class="mini-badge featured" *ngIf="product.featured">Featured</span>
                                    <span class="mini-badge new" *ngIf="product.newArrival">New</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="category-badge" [attr.data-category]="product.category || 'Tires'">
                                {{ product.category || 'Tires' }}
                            </span>
                        </td>
                        <td class="text-right">
                            <div class="price-stack">
                                <span class="current-price">${{ product.price | number:'1.2-2' }}</span>
                                <span class="compare-price" *ngIf="product.compareAtPrice">${{
                                    product.compareAtPrice | number:'1.2-2' }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="stock-indicator">
                                <div class="stock-pill" [class.success]="product.inStock && product.stockQuantity > 5"
                                    [class.warning]="product.inStock && product.stockQuantity <= 5"
                                    [class.danger]="!product.inStock || product.stockQuantity === 0">
                                    <span class="dot"></span>
                                    <span class="status-text">
                                        {{ product.stockQuantity > 0 ? product.stockQuantity + ' Units' : 'Out of
                                        Stock' }}
                                    </span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="row-actions">
                                <button class="btn-icon-ghost" [routerLink]="['/admin/products', product.id, 'edit']"
                                    title="Edit">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn-icon-ghost danger" (click)="deleteProduct(product)" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr *ngIf="products.length === 0">
                        <td colspan="7" class="empty-state">
                            No products found matching your criteria.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-wrapper">
            <app-pagination [config]="paginationConfig" (pageChange)="onPageChange($event)"
                (itemsPerPageChange)="onItemsPerPageChange($event)">
            </app-pagination>
        </div>

    </main>

    <ng-template #loading>
        <div class="glass-loader">
            <div class="spinner"></div>
            Loading Products...
        </div>
    </ng-template>

</div>