<div class="h-[calc(100vh-64px)] flex flex-col bg-zinc-950 overflow-hidden text-sm">

    <!-- Toolbar -->
    <div class="h-16 border-b border-zinc-800 bg-zinc-900/80 backdrop-blur flex items-center justify-between px-6 z-20">
        <div class="flex items-center gap-4">
            <button routerLink="/admin/warehouses" class="text-zinc-400 hover:text-white transition-colors">
                <app-icon name="arrow-left" class="w-5 h-5"></app-icon>
            </button>
            <div>
                <h1 class="text-lg font-bold text-white">{{ warehouse()?.name || 'Loading...' }}</h1>
                <p class="text-xs text-zinc-500">Visual Layout Editor / {{ warehouse()?.code }}</p>
            </div>
        </div>

        <div class="flex items-center gap-2">

            <!-- Grid Snap Toggle -->
            <div class="flex items-center gap-2 mr-4 bg-zinc-800 rounded px-2 py-1.5" title="Snap to Grid">
                <input type="checkbox" id="snap" [ngModel]="snapEnabled()" (ngModelChange)="snapEnabled.set($event)"
                    class="rounded border-zinc-600 bg-zinc-700 text-purple-600 focus:ring-purple-500">
                <label for="snap" class="text-xs text-zinc-300 cursor-pointer select-none">Grid Snap</label>
            </div>

            <!-- Zoom Controls -->
            <div class="flex items-center bg-zinc-800 rounded-lg p-1 mr-4">
                <button (click)="scale.set(scale() - 0.1)"
                    class="p-1.5 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded">
                    <app-icon name="minus" class="w-4 h-4"></app-icon>
                </button>
                <span class="text-xs text-zinc-300 w-10 text-center">{{ (scale() * 100).toFixed(0) }}%</span>
                <button (click)="scale.set(scale() + 0.1)"
                    class="p-1.5 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded">
                    <app-icon name="plus" class="w-4 h-4"></app-icon>
                </button>
            </div>

            <div class="h-8 w-px bg-zinc-700 mx-2"></div>

            <button (click)="addZone()" class="btn-glass-secondary flex items-center gap-2 px-3 py-1.5 text-xs">
                <app-icon name="plus-square" class="w-4 h-4"></app-icon>
                Zone
            </button>

            <button (click)="addStructure()" [disabled]="!selectedZoneId()"
                class="btn-glass-primary flex items-center gap-2 px-3 py-1.5 text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                <app-icon name="server" class="w-4 h-4"></app-icon>
                Rack
            </button>

            <button (click)="addObstacle()" class="btn-glass-secondary flex items-center gap-2 px-3 py-1.5 text-xs">
                <app-icon name="box" class="w-4 h-4"></app-icon>
                Obstacle
            </button>

            <button (click)="addDoor()" class="btn-glass-secondary flex items-center gap-2 px-3 py-1.5 text-xs">
                <app-icon name="log-out" class="w-4 h-4"></app-icon>
                Door
            </button>
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden relative">

        <!-- Canvas Area -->
        <div class="flex-1 bg-zinc-950 relative overflow-auto cursor-grab active:cursor-grabbing"
            (click)="onBackgroundClick()"
            [style.backgroundImage]="snapEnabled() ? 'radial-gradient(#27272a 1px, transparent 1px)' : 'none'"
            [style.backgroundSize]="gridSize() + 'px ' + gridSize() + 'px'">

            <!-- Infinite Grid Simulation or just a large container -->
            <div class="relative min-w-[2500px] min-h-[2500px] transform-origin-top-left transition-transform duration-75 p-20"
                [style.transform]="'scale(' + scale() + ')'">

                <!-- Physical Warehouse Boundary (Approx) -->
                <div
                    class="border-4 border-zinc-800 absolute top-20 left-20 w-[1500px] h-[1000px] rounded pointer-events-none">
                    <span class="absolute -top-8 left-0 text-zinc-500 font-mono text-xs">Warehouse Boundary: 150m x
                        100m</span>
                </div>

                <!-- OBSTACLES -->
                <div *ngFor="let obs of obstacles()"
                    class="absolute border border-zinc-600 bg-zinc-800 flex items-center justify-center cursor-move shadow-lg"
                    [style.left.px]="obs.x" [style.top.px]="obs.y" [style.width.px]="obs.width"
                    [style.height.px]="obs.height" [style.backgroundColor]="obs.color || '#27272a'"
                    [class.ring-2]="selectedElementId() === obs.id" [class.ring-white]="selectedElementId() === obs.id"
                    (mousedown)="onMouseDown($event, obs.id, 'obstacle', obs.x, obs.y)">
                    <app-icon name="slash" class="text-zinc-500 opacity-20 w-full h-full p-2"></app-icon>
                </div>

                <!-- DOORS -->
                <div *ngFor="let door of doors()" class="absolute flex flex-col items-center justify-center cursor-move"
                    [style.left.px]="door.x" [style.top.px]="door.y" [style.width.px]="door.width"
                    [style.height.px]="door.height" [class.ring-2]="selectedElementId() === door.id"
                    [class.ring-blue-500]="selectedElementId() === door.id"
                    (mousedown)="onMouseDown($event, door.id, 'door', door.x, door.y)">

                    <div class="w-full h-2 bg-emerald-500 rounded shadow-glow mb-1"></div>
                    <span class="text-[10px] font-mono text-zinc-400 whitespace-nowrap">{{ door.name }}</span>
                </div>

                <!-- ZONES -->
                <div *ngFor="let zone of zones()" class="absolute border-2 rounded-lg transition-shadow group"
                    [style.left.px]="zone.x" [style.top.px]="zone.y" [style.width.px]="zone.width"
                    [style.height.px]="zone.height" [style.borderColor]="zone.color"
                    [style.backgroundColor]="zone.color + '15'" [class.ring-2]="selectedElementId() === zone.id"
                    [class.ring-white]="selectedElementId() === zone.id"
                    (mousedown)="onMouseDown($event, zone.id, 'zone', zone.x, zone.y)"
                    (click)="selectElement(zone.id, 'zone', $event)">

                    <!-- Zone Label -->
                    <div class="absolute -top-7 left-0 px-2 py-0.5 rounded text-xs font-bold text-white whitespace-nowrap"
                        [style.backgroundColor]="zone.color">
                        {{ zone.name }}
                    </div>

                    <!-- Structures visual containment -->
                    <!-- Note: In data model, structures have X/Y relative to zone or warehouse. 
                         In previous code, it rendered structures INSIDE zones as DOM children. 
                         We kept that logic. So struct.x is relative to zone. -->

                    <div *ngFor="let struct of structures()" [hidden]="struct.zoneId !== zone.id"
                        class="absolute bg-zinc-800 border border-zinc-600 hover:border-purple-500 transition-colors cursor-move"
                        [style.left.px]="struct.x" [style.top.px]="struct.y" [style.width.px]="struct.width"
                        [style.height.px]="struct.height" [class.ring-1]="selectedElementId() === struct.id"
                        [class.ring-purple-400]="selectedElementId() === struct.id"
                        [class.bg-zinc-700]="selectedElementId() === struct.id"
                        (mousedown)="onMouseDown($event, struct.id, 'structure', struct.x, struct.y)"
                        (click)="selectElement(struct.id, 'structure', $event)"
                        (dblclick)="onElementDoubleClick(struct.id, 'structure', $event)">

                        <!-- Grid for bays/levels visualization (mini) -->
                        <div class="w-full h-full grid gap-px opacity-30 pointer-events-none"
                            [style.gridTemplateColumns]="'repeat(' + struct.bays + ', 1fr)'"
                            [style.gridTemplateRows]="'repeat(' + struct.levels + ', 1fr)'">
                            <div *ngFor="let i of [].constructor(struct.bays * struct.levels)" class="bg-zinc-500">
                            </div>
                        </div>

                        <!-- Direction Arrow (Simple) -->
                        <div class="absolute -bottom-4 w-full flex justify-center opacity-0 group-hover:opacity-50">
                            <app-icon name="arrow-down" [size]="12" class="text-zinc-500"></app-icon>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Properties Sidebar (Right) -->
        <div class="w-80 bg-zinc-900 border-l border-zinc-800 p-6 flex flex-col z-20 shadow-2xl relative"
            *ngIf="selectedElementId()">

            <div class="flex items-center justify-between mb-6">
                <h2 class="text-white font-semibold">Properties</h2>
                <button (click)="onBackgroundClick()" class="text-zinc-500 hover:text-white">
                    <app-icon name="x" class="w-4 h-4"></app-icon>
                </button>
            </div>

            <!-- ZONE PROPERTIES -->
            <div *ngIf="selectedElementType() === 'zone'">
                <ng-container *ngFor="let z of zones()">
                    <div *ngIf="z.id === selectedElementId()" class="space-y-4">
                        <div>
                            <label class="text-xs text-zinc-400 block mb-1">Zone Name</label>
                            <input type="text" [(ngModel)]="z.name"
                                class="w-full bg-zinc-950 border border-zinc-700 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-zinc-400 block mb-1">Color</label>
                            <input type="color" [(ngModel)]="z.color"
                                class="w-full h-8 bg-zinc-950 border border-zinc-700 rounded cursor-pointer">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-zinc-400 block mb-1">Width (px)</label>
                                <input type="number" [(ngModel)]="z.width"
                                    class="w-full bg-zinc-950 border border-zinc-700 rounded px-3 py-2 text-white text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-zinc-400 block mb-1">Height (px)</label>
                                <input type="number" [(ngModel)]="z.height"
                                    class="w-full bg-zinc-950 border border-zinc-700 rounded px-3 py-2 text-white text-sm">
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-4 pt-4 border-t border-zinc-800">
                            <div class="flex-1">
                                <label class="text-xs text-zinc-400 block">X Pos</label>
                                <input type="number" [(ngModel)]="z.x"
                                    class="w-full bg-zinc-950 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs text-zinc-400 block">Y Pos</label>
                                <input type="number" [(ngModel)]="z.y"
                                    class="w-full bg-zinc-950 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300">
                            </div>
                        </div>
                    </div>
                </ng-container>
            </div>

            <!-- STRUCTURE PROPERTIES -->
            <div *ngIf="selectedElementType() === 'structure'">
                <ng-container *ngFor="let s of structures()">
                    <div *ngIf="s.id === selectedElementId()" class="space-y-4">
                        <div>
                            <label class="text-xs text-zinc-400 block mb-1">Rack Name</label>
                            <input type="text" [(ngModel)]="s.name"
                                class="w-full bg-zinc-950 border border-zinc-700 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-zinc-400 block mb-1">Levels</label>
                                <input type="number" [(ngModel)]="s.levels"
                                    class="w-full bg-zinc-950 border border-zinc-700 rounded px-3 py-2 text-white text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-zinc-400 block mb-1">Bays</label>
                                <input type="number" [(ngModel)]="s.bays"
                                    class="w-full bg-zinc-950 border border-zinc-700 rounded px-3 py-2 text-white text-sm">
                            </div>
                        </div>
                        <button (click)="onElementDoubleClick(s.id, 'structure', $event)"
                            class="w-full py-2 bg-purple-600 hover:bg-purple-500 text-white rounded flex items-center justify-center gap-2 text-sm mt-2">
                            <app-icon name="eye" [size]="16"></app-icon> View Inventory
                        </button>
                    </div>
                </ng-container>
            </div>

            <!-- OBSTACLE / DOOR PROPS -->
            <div *ngIf="selectedElementType() === 'obstacle' || selectedElementType() === 'door'">
                <p class="text-zinc-500 italic text-sm">Basic properties available for this element.</p>
                <div class="mt-4" *ngIf="selectedElementType() === 'door'">
                    <ng-container *ngFor="let d of doors()">
                        <div *ngIf="d.id === selectedElementId()">
                            <label class="text-xs text-zinc-400 block mb-1">Dock Name</label>
                            <input type="text" [(ngModel)]="d.name"
                                class="w-full bg-zinc-950 border border-zinc-700 rounded px-3 py-2 text-white text-sm">
                        </div>
                    </ng-container>
                </div>
            </div>

            <div class="mt-auto pt-6 flex flex-col gap-2">
                <button (click)="saveChanges()" class="btn-glass-primary w-full justify-center">Save Changes</button>
                <button (click)="deleteSelection()" class="text-red-400 hover:text-red-300 text-sm py-2">Delete
                    Selection</button>
            </div>

        </div>

    </div>
</div>

<!-- Render Visualizer as Overlay -->
<app-rack-visualizer *ngIf="showRackVisualizer()" [structureId]="visualizerRackId()" (close)="closeVisualizer()">
</app-rack-visualizer>