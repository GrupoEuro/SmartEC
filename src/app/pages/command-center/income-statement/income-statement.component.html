<header class="page-header">
    <div class="header-content">
        <div class="header-left">
            <app-icon name="chart-bar" [size]="40" class="text-blue-500"></app-icon>
            <div class="header-text">
                <h1>{{ 'COMMAND_CENTER.INCOME_STATEMENT.TITLE' | translate }}</h1>
                <p>{{ 'COMMAND_CENTER.INCOME_STATEMENT.SUBTITLE' | translate }}</p>
            </div>
        </div>

        <div class="income-header-actions">

            <button class="btn-secondary" (click)="toggleComparison()">
                {{ showComparison ? ('COMMAND_CENTER.INCOME_STATEMENT.HIDE_COMPARISON' | translate) :
                ('COMMAND_CENTER.INCOME_STATEMENT.SHOW_COMPARISON' | translate) }}
            </button>
            <button class="btn-secondary" (click)="exportPDF()">
                <app-icon name="document" [size]="16"></app-icon> {{ 'COMMAND_CENTER.INCOME_STATEMENT.EXPORT_PDF' |
                translate }}
            </button>
            <button class="btn-secondary" (click)="exportToCSV()">
                <app-icon name="chart-bar" [size]="16"></app-icon> {{ 'COMMAND_CENTER.ACTIONS.EXPORT' | translate }}
            </button>

        </div>
    </div>
</header>

<div class="income-statement-page">
    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-state">
        <div class="spinner"></div>
        <p>{{ 'COMMAND_CENTER.LABELS.LOADING' | translate }}</p>
    </div>

    <!-- Income Statement -->
    <div *ngIf="!isLoading() && statement()" class="income-statement">
        <div class="statement-header">
            <h2>{{ 'COMMAND_CENTER.INCOME_STATEMENT.TITLE' | translate }}</h2>
            <p class="period">{{ statement()!.period }}</p>
            <div class="health-score" (click)="toggleHealthDetails()">
                <span class="health-icon">
                    <app-icon [name]="healthScoreStatus.icon" [class]="'text-' + healthScoreStatus.color"></app-icon>
                </span>
                <span class="health-label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.HEALTH_SCORE.LABEL' | translate
                    }}:</span>
                <span class="health-value" [style.color]="healthScoreStatus.color">
                    {{ financialHealthScore }}/100
                </span>
                <span class="health-status" [style.color]="healthScoreStatus.color">
                    {{ healthScoreStatus.label | translate }}
                </span>
                <span class="expand-icon">{{ showHealthDetails ? '▼' : '▶' }}</span>
            </div>

            <!-- Health Details Breakdown -->
            <div class="health-details" *ngIf="showHealthDetails && healthBreakdown">
                <div class="health-details-header">
                    <h4>{{ 'COMMAND_CENTER.INCOME_STATEMENT.HEALTH_SCORE.SCORE_BREAKDOWN' | translate }}</h4>
                    <p class="details-subtitle">{{ 'COMMAND_CENTER.INCOME_STATEMENT.HEALTH_SCORE.UNDERSTANDING' |
                        translate:{score: financialHealthScore} }}</p>
                </div>

                <div class="score-components">
                    <div class="component-card" *ngFor="let component of healthBreakdown.components">
                        <div class="component-header">
                            <span class="component-icon">
                                <app-icon [name]="component.status.icon"
                                    [style.color]="component.status.icon === 'circle-fill' ? (component.status.status === 'Excellent' ? '#22c55e' : component.status.status === 'Good' ? '#fbbf24' : component.status.status === 'Fair' ? '#f97316' : '#ef4444') : 'inherit'"></app-icon>
                            </span>
                            <span class="component-name">{{ component.name | translate }}</span>
                            <span class="component-score">{{ component.score }}/{{ component.maxScore }}</span>
                        </div>
                        <div class="component-progress">
                            <div class="progress-bar">
                                <div class="progress-fill"
                                    [style.width.%]="(component.score / component.maxScore) * 100"
                                    [style.background-color]="component.status.status === 'Excellent' ? '#22c55e' : 
                                                                component.status.status === 'Good' ? '#fbbf24' : 
                                                                component.status.status === 'Fair' ? '#f97316' : '#ef4444'">
                                </div>
                            </div>
                        </div>
                        <div class="component-details">
                            <span class="detail-label">Current:</span>
                            <span class="detail-value">{{ formatPercentage(component.value) }}</span>
                            <span class="detail-label">Target:</span>
                            <span class="detail-value">{{ formatPercentage(component.target) }}</span>
                        </div>
                        <p class="component-insight">{{ component.insight | translate }}</p>
                    </div>
                </div>

                <div class="recommendations" *ngIf="healthBreakdown.recommendations.length > 0">
                    <h5>{{ 'COMMAND_CENTER.INCOME_STATEMENT.RECOMMENDATIONS.TITLE' | translate }}</h5>
                    <ul>
                        <li *ngFor="let rec of healthBreakdown.recommendations">{{ rec | translate }}</li>
                    </ul>
                </div>

                <!-- Path to 100% Scenarios -->
                <div class="path-to-100" *ngIf="pathTo100">
                    <div class="path-header">
                        <h4>{{ 'COMMAND_CENTER.INCOME_STATEMENT.SCENARIOS.PATH_TITLE' | translate }}</h4>
                        <p class="path-subtitle">
                            {{ 'COMMAND_CENTER.INCOME_STATEMENT.SCENARIOS.PATH_SUBTITLE' | translate:{current:
                            pathTo100.currentScore, gap: pathTo100.gap} }}
                        </p>
                    </div>

                    <!-- Target Requirements -->
                    <div class="target-requirements">
                        <h5>{{ 'COMMAND_CENTER.INCOME_STATEMENT.SCENARIOS.REQUIREMENTS' | translate }}</h5>
                        <div class="requirement-grid">
                            <div class="requirement-item" *ngFor="let comp of pathTo100.components">
                                <span class="req-icon" [class.achieved]="comp.status === 'achieved'">
                                    <app-icon
                                        [name]="comp.status === 'achieved' ? 'check-circle' : 'alert-circle'"></app-icon>
                                </span>
                                <div class="req-details">
                                    <span class="req-name">{{ comp.name | translate }}</span>
                                    <span class="req-values">
                                        {{ 'COMMAND_CENTER.INCOME_STATEMENT.HEALTH_SCORE.INSIGHTS.CURRENT' | translate
                                        }}: {{ formatPercentage(comp.current) }} |
                                        {{ 'COMMAND_CENTER.INCOME_STATEMENT.HEALTH_SCORE.INSIGHTS.TARGET' | translate
                                        }}: {{ formatPercentage(comp.target) }}
                                        <span *ngIf="comp.gap > 0" class="req-gap">{{
                                            'COMMAND_CENTER.INCOME_STATEMENT.SCENARIOS.GAP_NEEDED' | translate:{val:
                                            formatPercentage(comp.gap)} }}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scenarios -->
                    <div class="scenarios-section">
                        <h5>{{ 'COMMAND_CENTER.INCOME_STATEMENT.SCENARIOS.CHOOSE_APPROACH' | translate }}</h5>
                        <div class="scenario-cards">
                            <div class="scenario-card" *ngFor="let scenario of pathTo100.scenarios">
                                <div class="scenario-header">
                                    <span class="scenario-icon">
                                        <app-icon [name]="scenario.icon" [size]="24"></app-icon>
                                    </span>
                                    <div class="scenario-title-group">
                                        <h6>{{ scenario.name | translate }}</h6>
                                        <p class="scenario-desc">{{ scenario.description | translate }}</p>
                                    </div>
                                </div>
                                <div class="scenario-body">
                                    <div class="scenario-actions">
                                        <div class="action-item" *ngFor="let action of scenario.actions">
                                            {{ action.key | translate:action.params }}
                                        </div>
                                    </div>
                                    <div class="scenario-meta">
                                        <span class="meta-item">
                                            <strong>{{ 'COMMAND_CENTER.INCOME_STATEMENT.SCENARIOS.NEW_SCORE' | translate
                                                }}</strong> {{ scenario.newScore }}/100
                                        </span>
                                        <span class="meta-item">
                                            <strong>{{ 'COMMAND_CENTER.INCOME_STATEMENT.SCENARIOS.DIFFICULTY' |
                                                translate }}</strong> {{ scenario.difficulty }}
                                        </span>
                                        <span class="meta-item">
                                            <strong>{{ 'COMMAND_CENTER.INCOME_STATEMENT.SCENARIOS.TIMEFRAME' | translate
                                                }}</strong> {{ scenario.timeframe }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Win -->
                    <div class="quick-win-card" *ngIf="pathTo100.quickWin">
                        <div class="quick-win-header">
                            <span class="quick-win-icon">
                                <app-icon name="target" [size]="20"></app-icon>
                                {{ pathTo100.quickWin.description | translate }}
                            </span>
                        </div>
                        <div class="quick-win-actions">
                            <div *ngFor="let action of pathTo100.quickWin.actions" class="quick-win-action">
                                {{ action.key | translate:action.params }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REVENUE SECTION -->
        <div class="pl-section">
            <h3 class="section-title">
                <span class="section-icon">
                    <app-icon name="wallet" [size]="20" class="text-yellow-400"></app-icon>
                </span>
                {{ 'COMMAND_CENTER.INCOME_STATEMENT.REVENUE' | translate }}
            </h3>
            <div class="pl-line">
                <span class="label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.GROSS_SALES' | translate }}</span>
                <span class="amount">{{ formatCurrency(statement()!.grossSales) }}</span>
                <span class="percentage"></span>
            </div>
            <div class="pl-line indent" *ngIf="statement()!.returns > 0">
                <span class="label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.LESS_RETURNS' | translate }}</span>
                <span class="amount negative">({{ formatCurrency(statement()!.returns) }})</span>
            </div>
            <div class="pl-line indent" *ngIf="statement()!.discounts > 0">
                <span class="label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.LESS_DISCOUNTS' | translate }}</span>
                <span class="amount negative">({{ formatCurrency(statement()!.discounts) }})</span>
            </div>
            <div class="pl-divider"></div>
            <div class="pl-line total">
                <span class="label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.NET_SALES' | translate }}</span>
                <span class="amount">{{ formatCurrency(statement()!.netSales) }}</span>
                <span class="percentage">100%</span>
            </div>
        </div>

        <!-- COGS SECTION -->
        <div class="pl-section">
            <h3 class="section-title">
                <span class="section-icon">
                    <app-icon name="box" [size]="20" class="text-blue-400"></app-icon>
                </span>
                {{ 'COMMAND_CENTER.INCOME_STATEMENT.COGS' | translate }}
            </h3>
            <div class="pl-line">
                <span class="label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.PRODUCT_COSTS' | translate }}</span>
                <span class="amount">{{ formatCurrency(statement()!.cogs) }}</span>
                <span class="percentage">{{ formatPercentage((statement()!.cogs / statement()!.netSales) * 100)
                    }}</span>
            </div>
        </div>

        <!-- GROSS PROFIT -->
        <div class="pl-section highlight">
            <div class="pl-line total">
                <span class="label">
                    {{ 'COMMAND_CENTER.INCOME_STATEMENT.GROSS_PROFIT' | translate }}
                    <span class="health-badge" [title]="getMarginHealth(statement()!.grossMargin, 'gross').status">
                        <app-icon [name]="getMarginHealth(statement()!.grossMargin, 'gross').icon"
                            [style.color]="getMarginHealth(statement()!.grossMargin, 'gross').status === 'Excellent' ? '#22c55e' : getMarginHealth(statement()!.grossMargin, 'gross').status === 'Good' ? '#fbbf24' : getMarginHealth(statement()!.grossMargin, 'gross').status === 'Fair' ? '#f97316' : '#ef4444'"></app-icon>
                    </span>
                </span>
                <span class="amount profit">{{ formatCurrency(statement()!.grossProfit) }}</span>
                <span class="percentage">{{ formatPercentage(statement()!.grossMargin) }}</span>
            </div>
        </div>

        <!-- OPERATING EXPENSES -->
        <div class="pl-section">
            <h3 class="section-title">
                <span class="section-icon">
                    <app-icon name="briefcase" [size]="20" class="text-indigo-400"></app-icon>
                </span>
                {{ 'COMMAND_CENTER.INCOME_STATEMENT.OPERATING_EXPENSES' | translate }}
            </h3>
            <div *ngIf="statement()!.operatingExpenses.length === 0" class="pl-line">
                <span class="label muted">{{ 'COMMAND_CENTER.INCOME_STATEMENT.NO_EXPENSES' | translate }}</span>
                <span class="amount">{{ formatCurrency(0) }}</span>
            </div>
            <div *ngFor="let expense of statement()!.operatingExpenses" class="pl-line">
                <span class="label">{{ expense.categoryName }}</span>
                <span class="amount">{{ formatCurrency(expense.amount) }}</span>
                <span class="percentage">{{ formatPercentage((expense.amount / statement()!.netSales) * 100) }}</span>
            </div>
            <div class="pl-divider"></div>
            <div class="pl-line total">
                <span class="label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.TOTAL_OPERATING_EXPENSES' | translate }}</span>
                <span class="amount">{{ formatCurrency(statement()!.totalOperatingExpenses) }}</span>
                <span class="percentage">{{ formatPercentage((statement()!.totalOperatingExpenses /
                    statement()!.netSales) * 100) }}</span>
            </div>
        </div>

        <!-- OPERATING INCOME -->
        <div class="pl-section highlight">
            <div class="pl-line total">
                <span class="label">
                    {{ 'COMMAND_CENTER.INCOME_STATEMENT.OPERATING_INCOME' | translate }}
                    <span class="health-badge"
                        [title]="getMarginHealth(statement()!.operatingMargin, 'operating').status">
                        <app-icon [name]="getMarginHealth(statement()!.operatingMargin, 'operating').icon"
                            [style.color]="getMarginHealth(statement()!.operatingMargin, 'operating').status === 'Excellent' ? '#22c55e' : getMarginHealth(statement()!.operatingMargin, 'operating').status === 'Good' ? '#fbbf24' : getMarginHealth(statement()!.operatingMargin, 'operating').status === 'Fair' ? '#f97316' : '#ef4444'"></app-icon>
                    </span>
                </span>
                <span class="amount" [class.profit]="statement()!.operatingIncome > 0"
                    [class.loss]="statement()!.operatingIncome < 0">
                    {{ formatCurrency(statement()!.operatingIncome) }}
                </span>
                <span class="percentage">{{ formatPercentage(statement()!.operatingMargin) }}</span>
            </div>
        </div>

        <!-- NET INCOME -->
        <div class="pl-section highlight-strong">
            <div class="pl-line total">
                <span class="label">
                    {{ 'COMMAND_CENTER.INCOME_STATEMENT.NET_INCOME' | translate }}
                    <span class="health-badge" [title]="getMarginHealth(statement()!.netMargin, 'net').status">
                        <app-icon [name]="getMarginHealth(statement()!.netMargin, 'net').icon"
                            [style.color]="getMarginHealth(statement()!.netMargin, 'net').status === 'Excellent' ? '#22c55e' : getMarginHealth(statement()!.netMargin, 'net').status === 'Good' ? '#fbbf24' : getMarginHealth(statement()!.netMargin, 'net').status === 'Fair' ? '#f97316' : '#ef4444'"></app-icon>
                    </span>
                </span>
                <span class="amount" [class.profit]="statement()!.netIncome > 0"
                    [class.loss]="statement()!.netIncome < 0">
                    {{ formatCurrency(statement()!.netIncome) }}
                </span>
                <span class="percentage">{{ formatPercentage(statement()!.netMargin) }}</span>
            </div>
        </div>

        <!-- KEY METRICS -->
        <div class="key-metrics">
            <div class="metric-card">
                <span class="metric-label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.GROSS_MARGIN' | translate }}</span>
                <span class="metric-value">{{ formatPercentage(statement()!.grossMargin) }}</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.OPERATING_MARGIN' | translate }}</span>
                <span class="metric-value">{{ formatPercentage(statement()!.operatingMargin) }}</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.NET_MARGIN' | translate }}</span>
                <span class="metric-value">{{ formatPercentage(statement()!.netMargin) }}</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.TOTAL_REVENUE' | translate }}</span>
                <span class="metric-value">{{ formatCurrency(statement()!.netSales) }}</span>
            </div>
        </div>

        <!-- Margin Progress Bars -->
        <div class="margin-indicators">
            <div class="margin-bar">
                <div class="margin-bar-header">
                    <span class="margin-label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.GROSS_MARGIN' | translate }}</span>
                    <span class="margin-value">{{ formatPercentage(statement()!.grossMargin) }}</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" [style.width.%]="statement()!.grossMargin"
                        [style.background-color]="getMarginColor(statement()!.grossMargin)">
                    </div>
                </div>
            </div>

            <div class="margin-bar">
                <div class="margin-bar-header">
                    <span class="margin-label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.OPERATING_MARGIN' | translate
                        }}</span>
                    <span class="margin-value">{{ formatPercentage(statement()!.operatingMargin) }}</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" [style.width.%]="statement()!.operatingMargin"
                        [style.background-color]="getMarginColor(statement()!.operatingMargin)">
                    </div>
                </div>
            </div>

            <div class="margin-bar">
                <div class="margin-bar-header">
                    <span class="margin-label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.NET_MARGIN' | translate }}</span>
                    <span class="margin-value">{{ formatPercentage(statement()!.netMargin) }}</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" [style.width.%]="statement()!.netMargin"
                        [style.background-color]="getMarginColor(statement()!.netMargin)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <app-chart-card [title]="'Revenue Trend'" [subtitle]="statement()?.period" [type]="'bar'"
                [data]="revenueTrendData()" [height]="300" [tableData]="revenueTableData()"
                [tableColumns]="revenueTableColumns">
            </app-chart-card>

            <app-chart-card *ngIf="statement()!.operatingExpenses.length > 0" [title]="'Expense Breakdown'"
                [subtitle]="statement()?.period" [type]="'doughnut'" [data]="expenseChartData()" [height]="300"
                [tableData]="expenseTableData()" [tableColumns]="expenseTableColumns">
            </app-chart-card>
        </div>

        <!-- Comparison (if enabled) -->
        <div *ngIf="showComparison && comparison()" class="comparison-section">
            <h3>{{ 'COMMAND_CENTER.INCOME_STATEMENT.PERIOD_COMPARISON' | translate }}</h3>
            <!-- ... comparison grid omitted for brevity ... -->
            <div class="comparison-grid">
                <div class="comparison-row">
                    <span class="label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.NET_SALES' | translate }}</span>
                    <span class="variance" [ngClass]="getVarianceClass(comparison()!.variance.netSales.amount)">
                        {{ formatVariance(comparison()!.variance.netSales) }}
                    </span>
                </div>
                <!-- ... other rows ... -->
                <div class="comparison-row">
                    <span class="label">{{ 'COMMAND_CENTER.INCOME_STATEMENT.NET_INCOME' | translate }}</span>
                    <span class="variance" [ngClass]="getVarianceClass(comparison()!.variance.netIncome.amount)">
                        {{ formatVariance(comparison()!.variance.netIncome) }}
                    </span>
                </div>
            </div>
        </div>

        <!-- System Diagnostics (Debug Mode) -->
        <app-dashboard-diagnostics [logs]="[]" [buildVersion]="'v1.1-ReactiveFix'"></app-dashboard-diagnostics>

    </div>
</div>