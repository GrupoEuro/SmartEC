<app-admin-page-header id="inventory-header" iconName="package" [title]="'OPERATIONS.INVENTORY.LOOKUP' | translate"
    [subtitle]="'OPERATIONS.INVENTORY.SUBTITLE' | translate" variant="operations">
    <app-help-context-button id="inventory-help-btn" topicId="inventory-receiving"
        tooltip="View Receiving Guide"></app-help-context-button>
</app-admin-page-header>

<div class="list-container p-6 max-w-7xl mx-auto space-y-6">
    <!-- Filters and Search Section -->
    <div
        class="filters-bar flex flex-col md:flex-row justify-between items-start md:items-center bg-zinc-800 p-4 rounded-xl shadow-lg gap-4">
        <div class="search-and-filters flex flex-1 w-full md:w-auto gap-4 flex-wrap items-center">
            <!-- Search Bar (FULL WIDTH) -->
            <div class="search-box relative flex-1 min-w-[300px]" id="inventory-search">
                <span class="search-icon absolute left-3 top-2.5"><app-icon name="search" [size]="18"
                        class="text-zinc-500"></app-icon></span>
                <input type="text" [formControl]="searchControl"
                    [placeholder]="'ADMIN.PRODUCTS.SEARCH_PLACEHOLDER' | translate"
                    class="search-input w-full pl-10 pr-4 py-2 bg-zinc-900 border border-zinc-700 rounded-lg text-sm text-white placeholder-zinc-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors">
            </div>

            <!-- Filter Controls -->
            <div class="filter-controls flex items-center gap-3 flex-wrap" id="inventory-filters">
                <!-- Stock Filter -->
                <select [ngModel]="stockStatusFilter()" (ngModelChange)="setStockFilter($event)"
                    class="filter-select bg-zinc-900 border border-zinc-700 text-zinc-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 hover:bg-zinc-800 cursor-pointer transition-colors">
                    <option value="all">{{ 'ADMIN.PRODUCTS.ALL_STOCK' | translate }}</option>
                    <option value="in">{{ 'ADMIN.PRODUCTS.STOCK_IN' | translate }}</option>
                    <option value="low">{{ 'ADMIN.PRODUCTS.STOCK_LOW' | translate }}</option>
                    <option value="out">{{ 'ADMIN.PRODUCTS.STOCK_OUT' | translate }}</option>
                </select>

                <!-- Brand Filter -->
                <select [ngModel]="brandFilter()" (change)="setBrandFilter($event)"
                    class="filter-select bg-zinc-900 border border-zinc-700 text-zinc-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 hover:bg-zinc-800 cursor-pointer transition-colors">
                    <option value="all">{{ 'ADMIN.PRODUCTS.ALL_BRANDS' | translate }}</option>
                    <option *ngFor="let brand of availableBrands()" [value]="brand">{{ brand }}</option>
                </select>
            </div>

            <!-- Clear Filters -->
            <button *ngIf="stockStatusFilter() !== 'all' || brandFilter() !== 'all' || searchControl.value"
                class="btn-clear-filters text-zinc-400 hover:text-white underline text-sm transition-colors"
                (click)="clearFilters()">
                {{ 'OPERATIONS.INVENTORY.CLEAR_FILTERS' | translate }}
            </button>

            <!-- Export Button -->
            <button id="inventory-export"
                class="btn-glass-primary small icon flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all"
                (click)="handleExport()" [title]="'OPERATIONS.INVENTORY.EXPORT_CSV' | translate">
                <app-icon name="download" [size]="16"></app-icon> {{ 'OPERATIONS.INVENTORY.EXPORT_CSV' |
                translate }}
            </button>
        </div>
    </div>

    <!-- Table Section -->
    <div class="operations-table-container" *ngIf="!isLoading(); else loading">
        <table class="operations-table w-full text-left border-collapse">
            <thead class="bg-zinc-900/50 text-zinc-400 text-xs uppercase font-semibold">
                <tr>
                    <th class="p-4 border-b border-zinc-700">{{ 'ADMIN.PRODUCTS.TH_IMAGE' | translate }}</th>
                    <th class="p-4 border-b border-zinc-700 cursor-pointer hover:text-white transition-colors sortable"
                        (click)="onSortChange('name')">
                        <div class="flex items-center gap-1">
                            {{ 'ADMIN.PRODUCTS.TH_PRODUCT' | translate }}
                            <span class="sort-indicator text-blue-500" *ngIf="sortField === 'name'">
                                <app-icon [name]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"
                                    [size]="14"></app-icon>
                            </span>
                        </div>
                    </th>
                    <th class="p-4 border-b border-zinc-700 cursor-pointer hover:text-white transition-colors sortable"
                        (click)="onSortChange('sku')">
                        <div class="flex items-center gap-1">
                            {{ 'ADMIN.PRODUCTS.TH_SKU' | translate }}
                            <span class="sort-indicator text-blue-500" *ngIf="sortField === 'sku'">
                                <app-icon [name]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"
                                    [size]="14"></app-icon>
                            </span>
                        </div>
                    </th>
                    <th class="p-4 border-b border-zinc-700 cursor-pointer hover:text-white transition-colors sortable text-right"
                        (click)="onSortChange('stockQuantity')">
                        <div class="flex items-center justify-end gap-1">
                            {{ 'ADMIN.PRODUCTS.TH_STOCK' | translate }}
                            <span class="sort-indicator text-blue-500" *ngIf="sortField === 'stockQuantity'">
                                <app-icon [name]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"
                                    [size]="14"></app-icon>
                            </span>
                        </div>
                    </th>
                    <th class="p-4 border-b border-zinc-700 cursor-pointer hover:text-white transition-colors sortable text-right"
                        (click)="onSortChange('price')">
                        <div class="flex items-center justify-end gap-1">
                            {{ 'ADMIN.PRODUCTS.TH_PRICE' | translate }}
                            <span class="sort-indicator text-blue-500" *ngIf="sortField === 'price'">
                                <app-icon [name]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"
                                    [size]="14"></app-icon>
                            </span>
                        </div>
                    </th>
                    <th class="p-4 border-b border-zinc-700 text-center w-24">History</th>
                </tr>
            </thead>
            <tbody class="text-zinc-300 text-sm">
                <tr *ngFor="let product of displayedProducts"
                    class="border-b border-zinc-800 hover:bg-zinc-700/30 transition-colors">
                    <td class="p-4">
                        <div
                            class="product-image w-12 h-12 bg-zinc-700 rounded-lg flex items-center justify-center overflow-hidden border border-zinc-600">
                            <img *ngIf="product.images.main" [src]="product.images.main" [alt]="product.name.en"
                                class="w-full h-full object-cover">
                            <span *ngIf="!product.images.main" class="no-image text-zinc-400 font-bold text-lg">{{
                                product.name.en.charAt(0) }}</span>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="product-info flex flex-col gap-1">
                            <strong class="text-white">{{ product.name.es }}</strong>
                            <span class="product-name-es text-xs text-zinc-500 italic">{{ product.name.en }}</span>
                            <div class="product-badges flex flex-wrap gap-1 mt-1">
                                <span
                                    class="badge badge-featured px-1.5 py-0.5 rounded text-[10px] font-bold uppercase bg-purple-900/30 text-purple-400 border border-purple-800/50"
                                    *ngIf="product.featured">
                                    {{ 'ADMIN.PRODUCTS.BADGE_FEATURED' | translate }}
                                </span>
                            </div>
                            <span class="product-brand text-[10px] uppercase font-bold text-zinc-500 tracking-wider">{{
                                product.brand }}</span>
                        </div>
                    </td>
                    <td
                        class="p-4 font-mono text-xs text-zinc-400 bg-zinc-900/30 rounded px-2 py-1 fit-content border border-zinc-800">
                        {{ product.sku }}</td>
                    <td class="p-4 text-right">
                        <div class="flex flex-col items-end gap-1">
                            <!-- Primary: Available -->
                            <span class="text-sm font-bold" [ngClass]="{
                                 'text-emerald-400': (product.availableStock ?? product.stockQuantity) > 5,
                                 'text-amber-400': (product.availableStock ?? product.stockQuantity) <= 5 && (product.availableStock ?? product.stockQuantity) > 0,
                                 'text-red-400': (product.availableStock ?? product.stockQuantity) <= 0
                             }">
                                {{ product.availableStock ?? product.stockQuantity }} Available
                            </span>

                            <!-- Secondary: Physical & Reserved -->
                            <div
                                class="flex items-center gap-2 text-[10px] text-zinc-500 font-medium uppercase tracking-wide">
                                <span>Phys: {{ product.stockQuantity }}</span>
                                <span
                                    *ngIf="(product.stockQuantity - (product.availableStock ?? product.stockQuantity)) > 0"
                                    class="text-amber-500 bg-amber-900/30 px-1.5 py-0.5 rounded border border-amber-900/50">
                                    Res: {{ product.stockQuantity - (product.availableStock ?? product.stockQuantity) }}
                                </span>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-right font-bold text-zinc-100 font-mono">
                        {{ product.price | currency:'MXN' }}
                    </td>
                    <td class="p-4 text-center">
                        <button (click)="openKardex(product)"
                            class="p-2 text-zinc-400 hover:text-blue-400 hover:bg-zinc-700 rounded-full transition-colors flex items-center justify-center mx-auto"
                            title="View History">
                            <app-icon name="clock" [size]="18"></app-icon>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>

        <app-pagination [config]="paginationConfig" [translationPrefix]="'OPERATIONS.INVENTORY'"
            (pageChange)="onPageChange($event)">
        </app-pagination>
    </div>

    <!-- Loading State -->
    <ng-template #loading>
        <div class="loading-container">
            <div class="spinner"></div>
            <p>{{ 'ADMIN.PRODUCTS.LOADING' | translate }}</p>
        </div>
    </ng-template>

</div>

<!-- The Kardex Drawer -->
<app-inventory-kardex [isOpen]="showKardex()" [product]="selectedKardexProduct()" (close)="closeKardex()">
</app-inventory-kardex>